<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å»¶è¾¹ABCæ¸¸æˆåä¼š</title>
    <link rel="icon" href="å»¶è¾¹ABC Logo.png">
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
            margin: 0;
            padding: 0;
            color: #222;
        }
        header {
            background: #2d8cf0;
            color: #fff;
            padding: 30px 0 20px 0;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        header img {
            width: 80px;
            border-radius: 20px;
            margin-bottom: 10px;
        }
        h1 {
            margin: 10px 0 5px 0;
            font-size: 2.5em;
            letter-spacing: 2px;
        }
        .subtitle {
            font-size: 1.2em;
            color: #e0eafc;
            margin-bottom: 10px;
        }
        main {
            max-width: 900px;
            margin: 30px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(45,140,240,0.08);
            padding: 32px 24px 24px 24px;
        }
        .games {
            display: flex;
            flex-wrap: wrap;
            gap: 32px;
            justify-content: center;
            margin-bottom: 40px;
        }
        .game-card {
            background: #f7faff;
            border-radius: 14px;
            box-shadow: 0 2px 8px rgba(45,140,240,0.07);
            width: 210px;
            text-align: center;
            padding: 24px 12px 18px 12px;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            text-decoration: none;
            color: #222;
        }
        .game-card:hover {
            transform: translateY(-6px) scale(1.04);
            box-shadow: 0 8px 24px rgba(45,140,240,0.15);
            background: #e6f0fa;
        }
        .game-card img {
            width: 80px;
            height: 80px;
            object-fit: contain;
            margin-bottom: 12px;
        }
        .game-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 6px;
        }
        .game-desc {
            font-size: 0.98em;
            color: #666;
        }
        .section-title {
            font-size: 1.4em;
            font-weight: bold;
            margin: 32px 0 12px 0;
            color: #2d8cf0;
        }
        .dev-section {
            background: #f0f7ff;
            border-radius: 10px;
            padding: 18px 20px;
            margin-bottom: 30px;
        }
        .contact {
            text-align: center;
            color: #888;
            font-size: 1em;
            margin-top: 30px;
        }
        @media (max-width: 700px) {
            main { padding: 10px 2vw; }
            .games { flex-direction: column; align-items: center; gap: 18px; }
            .game-card { width: 95vw; max-width: 340px; }
        }
        #chat-form {
          display: flex;
          align-items: center;
          border-top: 1px solid #e0eafc;
          background: #fff;
          padding: 0;
          width: 100%;
          box-sizing: border-box;
        }
        #chat-form button[type="button"] {
          background: none;
          border: none;
          font-size: 1.3em;
          cursor: pointer;
          margin: 0 2px;
          padding: 0 6px;
          width: 32px;
          height: 32px;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          overflow: visible;
        }
        #chat-input {
          flex: 1;
          min-width: 0;
          padding: 8px 10px;
          border: none;
          border-radius: 0 0 0 18px;
          font-size: 1em;
          outline: none;
          background: #fff;
          margin: 0 2px;
        }
        #chat-form button[type="submit"] {
          background: #2d8cf0;
          color: #fff;
          border: none;
          padding: 0 18px;
          border-radius: 0 0 18px 0;
          font-size: 1em;
          cursor: pointer;
          margin-left: 2px;
          height: 32px;
          display: inline-flex;
          align-items: center;
          justify-content: center;
        }
        @media (max-width: 500px) {
          #chat-form button[type="button"], #chat-form button[type="submit"] {
            width: 28px;
            height: 28px;
            font-size: 1.1em;
            padding: 0 2px;
          }
          #chat-input {
            font-size: 0.95em;
            padding: 6px 6px;
          }
        }
    </style>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js" onerror="console.warn('PeerJS CDNåŠ è½½å¤±è´¥ï¼Œè§†é¢‘é€šè¯åŠŸèƒ½å°†ä¸å¯ç”¨')"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2" onerror="console.warn('Supabase CDNåŠ è½½å¤±è´¥ï¼Œç³»ç»Ÿå°†ä½¿ç”¨æœ¬åœ°å­˜å‚¨æ¨¡å¼')"></script>
</head>
<body>
    <header>
        <img src="å»¶è¾¹ABC Logo.png" alt="å»¶è¾¹ABC Logo">
        <h1>å»¶è¾¹ABCæ¸¸æˆåä¼š</h1>
        <div class="subtitle">ä¸“æ³¨äºç½‘ç»œæ¸¸æˆä¸åˆ›æ–°å¼€å‘ | äº”å­æ£‹ã€ä¿„ç½—æ–¯æ–¹å—ã€å¼€å¿ƒæ¶ˆæ¶ˆä¹ã€å†°æ¡¶æŒ‘æˆ˜</div>
        <div id="user-bar" style="position:absolute;top:30px;right:40px;font-size:1em;background-color:rgba(0,0,0,0.3);padding:8px 15px;border-radius:25px;box-shadow:0 2px 10px rgba(0,0,0,0.2);">
            <button id="login-btn" style="padding:6px 18px;border-radius:20px;background:#fff;color:#082d57;border:none;cursor:pointer;font-weight:bold;">ä¼šå‘˜æ³¨å†Œ/ç™»å½•</button>
        </div>
    </header>
    <!-- é¡¶éƒ¨é€šçŸ¥æ¨ªå‘æ»šåŠ¨æ¡ -->
    <div id="notice-marquee-bar" style="width:100%;max-width:900px;margin:10px auto 0 auto;display:flex;align-items:center;min-height:36px;background:linear-gradient(90deg,#e0eafc 60%,#f7faff 100%);border-radius:8px;box-shadow:0 2px 8px #0001;font-size:1.1em;color:#2d8cf0;position:relative;overflow:hidden;">
      <div style="padding:0 12px;font-weight:bold;">é€šçŸ¥ï¼š</div>
      <div id="notice-marquee-wrap" style="flex:1;overflow:hidden;position:relative;height:36px;display:flex;align-items:center;"><div id="notice-marquee" style="white-space:nowrap;display:inline-block;position:absolute;left:0;top:0;"></div></div>
    </div>
    <!-- é¡¶éƒ¨æ¨ªå¹…å¹¿å‘Šä½ -->
    <div id="ad-banner" style="width:100%;max-width:900px;margin:18px auto 0 auto;display:flex;justify-content:center;align-items:center;min-height:70px;max-height:90px;overflow:auto;background:linear-gradient(90deg,#f7faff 60%,#e0eafc 100%);border-radius:12px;box-shadow:0 2px 8px #0001;font-size:1.2em;color:#2d8cf0;letter-spacing:2px;position:relative;">
      <div id="ad-banner-content" style="width:100%;padding:8px 0;">
        <!-- å¹¿å‘Šå†…å®¹ç”±JSæ¸²æŸ“ -->
      </div>
    </div>
    <main>
        <div class="section-title">çƒ­é—¨æ¸¸æˆ</div>
        <div class="games">
            <a class="game-card" href="äº”å­æ£‹/äº”å­æ£‹.html" target="_blank">
                <img src="äº”å­æ£‹/äº”å­æ£‹.png" alt="äº”å­æ£‹">
                <div class="game-title">äº”å­æ£‹</div>
                <div class="game-desc">ç»å…¸äººæœºå¯¹æˆ˜ï¼Œç­–ç•¥ä¸æ™ºæ…§çš„è¾ƒé‡ã€‚</div>
            </a>
            <a class="game-card" href="ä¿„ç½—æ–¯æ–¹å—/ä¿„ç½—æ–¯æ–¹å—.html" target="_blank">
                <img src="ä¿„ç½—æ–¯æ–¹å—/ä¿„ç½—æ–¯æ–¹å—.png" alt="ä¿„ç½—æ–¯æ–¹å—">
                <div class="game-title">ä¿„ç½—æ–¯æ–¹å—</div>
                <div class="game-desc">æ¶ˆé™¤æ–¹å—ï¼ŒæŒ‘æˆ˜æé™ï¼Œç«¥å¹´å›å¿†ã€‚</div>
            </a>
            <a class="game-card" href="å¼€å¿ƒæ¶ˆæ¶ˆä¹/kaixinlian/index.html" target="_blank">
                <img src="å¼€å¿ƒæ¶ˆæ¶ˆä¹/kaixinlian/kaixinlian.png" alt="å¼€å¿ƒæ¶ˆæ¶ˆä¹">
                <div class="game-title">å¼€å¿ƒæ¶ˆæ¶ˆä¹</div>
                <div class="game-desc">ä¸‰æ¶ˆé—¯å…³ï¼Œè¶£å‘³æ— é™ï¼Œé€‚åˆæ‰€æœ‰å¹´é¾„ã€‚</div>
            </a>
            <a class="game-card" href="å†°æ¡¶/index.html" target="_blank">
                <img src="å†°æ¡¶/img/bucket.png" alt="ë‚˜ë¥¼ì¡ì•„ë´ë´">
                <div class="game-title">ë‚˜ë¥¼ì¡ì•„ë´ë´</div>
                <div class="game-desc">è¶£å‘³æŒ‘æˆ˜ï¼Œååº”ä¸å‹‡æ°”çš„è€ƒéªŒã€‚</div>
            </a>
            <div class="game-card" id="member-games-platform" style="cursor:pointer;border:2px dashed #2d8cf0;">
                <div style="font-size:3em;color:#2d8cf0;margin-bottom:12px;">ğŸ®</div>
                <div class="game-title">ä¼šå‘˜æ¸¸æˆå¹³å°</div>
                <div class="game-desc">ä¼šå‘˜å¼€å‘ä½œå“å±•ç¤ºï¼Œæ”¯æŒä¸Šä¼ åˆ†äº«ã€‚</div>
                <div style="margin-top:8px;font-size:0.9em;color:#2d8cf0;">ç‚¹å‡»æŸ¥çœ‹</div>
            </div>
            <div class="game-card" id="upload-game-btn" style="cursor:pointer;border:2px dashed #f39c12;">
                <div style="font-size:3em;color:#f39c12;margin-bottom:12px;">ğŸ“¤</div>
                <div class="game-title">ä¸Šä¼ æ¸¸æˆ</div>
                <div class="game-desc">ä¼šå‘˜å¯ä¸Šä¼ è‡ªå·±çš„æ¸¸æˆä½œå“ã€‚</div>
                <div style="margin-top:8px;font-size:0.9em;color:#f39c12;">ç‚¹å‡»ä¸Šä¼ </div>
            </div>
            <div class="game-card" id="more-games-btn" style="cursor:pointer;border:2px dashed #9c27b0;width:60px;height:40px;display:flex;align-items:center;justify-content:center;padding:6px;">
                <div style="font-size:0.8em;color:#9c27b0;font-weight:bold;">æ›´å¤šæ¸¸æˆ</div>
            </div>
        </div>
        <div class="section-title">æ¸¸æˆå¼€å‘ä¸åˆä½œ</div>
        <div class="dev-section">
            <p>å»¶è¾¹ABCæ¸¸æˆåä¼šä¸ä»…ä¸“æ³¨äºç²¾å“ç½‘ç»œæ¸¸æˆçš„å¼€å‘ä¸è¿è¥ï¼Œè¿˜æ‰¿æ¥å„ç±»æ¸¸æˆå®šåˆ¶å¼€å‘ã€H5å°æ¸¸æˆã€å¾®ä¿¡/æŠ–éŸ³å°æ¸¸æˆã€ä¼ä¸šäº’åŠ¨å¨±ä¹è§£å†³æ–¹æ¡ˆç­‰ä¸šåŠ¡ã€‚</p>
            <ul>
                <li>ä¸“ä¸šå›¢é˜Ÿï¼Œä¸°å¯Œç»éªŒï¼Œæ”¯æŒå¤šå¹³å°ä¸Šçº¿</li>
                <li>å¯å®šåˆ¶äº”å­æ£‹ã€æ¶ˆæ¶ˆä¹ã€ä¿„ç½—æ–¯æ–¹å—ç­‰å¤šç§ç©æ³•</li>
                <li>æ”¯æŒç§¯åˆ†ã€æ’è¡Œæ¦œã€ç¤¾äº¤åˆ†äº«ã€å¹¿å‘Šå˜ç°ç­‰åŠŸèƒ½</li>
                <li>æ¬¢è¿ä¼ä¸šã€å­¦æ ¡ã€ä¸ªäººæ´½è°ˆåˆä½œï¼Œå…±åˆ›æ¸¸æˆæ–°ä½“éªŒï¼</li>
            </ul>
        </div>
        <div class="section-title">è”ç³»æˆ‘ä»¬</div>
        <!-- åº•éƒ¨å¤§çŸ©å½¢å¹¿å‘Šä½ -->
        <div id="ad-footer" style="width:100%;max-width:900px;margin:28px auto 18px auto;min-height:120px;max-height:140px;overflow:auto;display:flex;justify-content:center;align-items:center;background:linear-gradient(90deg,#e0eafc 60%,#f7faff 100%);border-radius:16px;box-shadow:0 2px 12px #0001;font-size:1.3em;color:#2d8cf0;position:relative;">
          <div id="ad-footer-content" style="width:100%;padding:12px 0;text-align:center;"></div>
        </div>
        <div class="contact">
            é‚®ç®±ï¼šabcgame@ybabc.com<br>
            å¾®ä¿¡ï¼šyb_abcgame<br>
            åœ°å€ï¼šå»¶è¾¹æœé²œæ—è‡ªæ²»å·åˆ›æ–°åˆ›ä¸šå›­
        </div>
    </main>
    <!-- ç™»å½•/æ³¨å†Œå¼¹çª— -->
    <div id="auth-modal" style="display:none;position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;">
      <div style="background:linear-gradient(to bottom, #f9f9f9, #fff);border-radius:15px;box-shadow:0 8px 32px rgba(0,0,0,0.2);padding:32px 28px 22px 28px;min-width:350px;max-width:90vw;border:1px solid #e0eafc;">
        <h2 id="auth-title" style="margin:0 0 22px 0;text-align:center;color:#063d77;font-size:1.6em;border-bottom:2px solid #2d8cf0;padding-bottom:10px;">ä¼šå‘˜ç™»å½•</h2>
        <form id="auth-form" autocomplete="off">
          <div style="margin-bottom:18px;">
            <input id="auth-username" type="text" placeholder="ç”¨æˆ·å" required style="width:100%;padding:12px 15px;font-size:1.1em;border-radius:8px;border:1px solid #ccc;box-shadow:inset 0 1px 3px rgba(0,0,0,0.1);">
          </div>
          <div style="margin-bottom:22px;">
            <input id="auth-password" type="password" placeholder="å¯†ç " required style="width:100%;padding:12px 15px;font-size:1.1em;border-radius:8px;border:1px solid #ccc;box-shadow:inset 0 1px 3px rgba(0,0,0,0.1);">
          </div>
          <button type="submit" style="width:100%;padding:12px 0;background:linear-gradient(to bottom, #2d8cf0, #2170c8);color:#fff;font-size:1.2em;border:none;border-radius:8px;font-weight:bold;box-shadow:0 2px 5px rgba(0,0,0,0.2);transition:all 0.2s ease;">ç™»å½•</button>
        </form>
        <div style="margin-top:15px;text-align:center;">
          <span id="toggle-auth" style="color:#2d8cf0;cursor:pointer;font-weight:bold;padding:5px 10px;border-radius:15px;background:#f0f7ff;transition:all 0.2s ease;">æ²¡æœ‰è´¦å·ï¼Ÿæ³¨å†Œ</span>
        </div>
        <div id="auth-error" style="color:#f44336;text-align:center;margin-top:12px;padding:8px;background:#ffebee;border-radius:5px;display:none;font-weight:bold;"></div>
      </div>
    </div>
    
    <!-- ä¼šå‘˜ä¿¡æ¯ç®¡ç†å¼¹çª— -->
    <div id="member-profile-modal" style="display:none;position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;">
      <div style="background:linear-gradient(to bottom, #f9f9f9, #fff);border-radius:15px;box-shadow:0 8px 32px rgba(0,0,0,0.2);padding:32px 28px 18px 28px;min-width:350px;max-width:90vw;max-height:90vh;overflow-y:auto;border:1px solid #e0eafc;">
        <h2 style="margin:0 0 20px 0;text-align:center;color:#032244;font-size:1.6em;border-bottom:2px solid #2d8cf0;padding-bottom:10px;">ä¼šå‘˜ä¿¡æ¯ç®¡ç†</h2>
        <form id="member-profile-form" autocomplete="off">
          <div style="margin-bottom:18px;">
            <label style="display:block;margin-bottom:8px;font-weight:bold;color:#2d8cf0;">ç”¨æˆ·åï¼š</label>
            <input id="profile-username" type="text" readonly style="width:100%;padding:12px 15px;font-size:1.1em;border-radius:8px;border:1px solid #ccc;background:#f5f5f5;box-shadow:inset 0 1px 3px rgba(0,0,0,0.1);">
          </div>
          <div style="margin-bottom:22px;background:#f0f7ff;padding:15px;border-radius:10px;border-left:4px solid #2d8cf0;">
            <label style="display:block;margin-bottom:8px;font-weight:bold;color:#2d8cf0;">æ›´æ”¹å¯†ç ï¼š</label>
            <input id="profile-old-password" type="password" placeholder="å½“å‰å¯†ç " style="width:100%;padding:12px 15px;font-size:1.1em;border-radius:8px;border:1px solid #ccc;margin-bottom:10px;box-shadow:inset 0 1px 3px rgba(0,0,0,0.1);">
            <input id="profile-new-password" type="password" placeholder="æ–°å¯†ç " style="width:100%;padding:12px 15px;font-size:1.1em;border-radius:8px;border:1px solid #ccc;margin-bottom:10px;box-shadow:inset 0 1px 3px rgba(0,0,0,0.1);">
            <input id="profile-confirm-password" type="password" placeholder="ç¡®è®¤æ–°å¯†ç " style="width:100%;padding:12px 15px;font-size:1.1em;border-radius:8px;border:1px solid #ccc;box-shadow:inset 0 1px 3px rgba(0,0,0,0.1);">
          </div>
          <div style="margin-bottom:18px;">
            <label style="display:block;margin-bottom:8px;font-weight:bold;color:#2d8cf0;">æ‰€åœ¨åŸå¸‚ï¼š</label>
            <input id="profile-city" type="text" placeholder="è¯·è¾“å…¥æ‚¨æ‰€åœ¨çš„åŸå¸‚" style="width:100%;padding:12px 15px;font-size:1.1em;border-radius:8px;border:1px solid #ccc;box-shadow:inset 0 1px 3px rgba(0,0,0,0.1);">
          </div>
          <div style="margin-bottom:18px;">
            <label style="display:block;margin-bottom:8px;font-weight:bold;color:#2d8cf0;">æ¯•ä¸šé™¢æ ¡ï¼š</label>
            <input id="profile-school" type="text" placeholder="è¯·è¾“å…¥æ‚¨çš„æ¯•ä¸šé™¢æ ¡" style="width:100%;padding:12px 15px;font-size:1.1em;border-radius:8px;border:1px solid #ccc;box-shadow:inset 0 1px 3px rgba(0,0,0,0.1);">
          </div>
          <div style="margin-bottom:18px;">
            <label style="display:block;margin-bottom:8px;font-weight:bold;color:#2d8cf0;">ä¸“ä¸šï¼š</label>
            <input id="profile-major" type="text" placeholder="è¯·è¾“å…¥æ‚¨çš„ä¸“ä¸š" style="width:100%;padding:12px 15px;font-size:1.1em;border-radius:8px;border:1px solid #ccc;box-shadow:inset 0 1px 3px rgba(0,0,0,0.1);">
          </div>
          <div style="margin-bottom:22px;">
            <label style="display:block;margin-bottom:8px;font-weight:bold;color:#2d8cf0;">çˆ±å¥½å…´è¶£ï¼š</label>
            <textarea id="profile-interests" placeholder="è¯·è¾“å…¥æ‚¨çš„çˆ±å¥½å…´è¶£ï¼Œå¤šä¸ªçˆ±å¥½å¯ç”¨é€—å·åˆ†éš”" style="width:100%;padding:12px 15px;font-size:1.1em;border-radius:8px;border:1px solid #ccc;resize:vertical;height:90px;box-shadow:inset 0 1px 3px rgba(0,0,0,0.1);"></textarea>
          </div>
          <div style="display:flex;gap:15px;">
            <button type="submit" style="flex:1;padding:12px 0;background:linear-gradient(to bottom, #2d8cf0, #2170c8);color:#fff;font-size:1.2em;border:none;border-radius:8px;font-weight:bold;box-shadow:0 2px 5px rgba(0,0,0,0.2);transition:all 0.2s ease;">ä¿å­˜ä¿¡æ¯</button>
            <button type="button" id="cancel-profile" style="flex:1;padding:12px 0;background:#e0e0e0;color:#333;border:none;border-radius:8px;font-size:1.1em;cursor:pointer;box-shadow:0 2px 5px rgba(0,0,0,0.1);transition:all 0.2s ease;">å–æ¶ˆ</button>
          </div>
        </form>
        <div id="profile-error" style="color:#f44336;text-align:center;margin-top:12px;padding:8px;background:#ffebee;border-radius:5px;display:none;font-weight:bold;"></div>
        <div id="profile-success" style="color:#4caf50;text-align:center;margin-top:12px;padding:8px;background:#e8f5e9;border-radius:5px;display:none;font-weight:bold;"></div>
      </div>
    </div>

    <!-- èƒŒæ™¯éŸ³ä¹æ’­æ”¾å™¨ -->
    <audio id="bg-music" src="å¼€å¿ƒæ¶ˆæ¶ˆä¹/kaixinlian/audio/SeaTreasureMatch.mp3" loop></audio>
    <div id="music-bar" style="position:fixed;bottom:18px;right:24px;z-index:999;background:#fff8;padding:8px 18px 8px 12px;border-radius:24px;box-shadow:0 2px 8px #0001;display:flex;align-items:center;gap:8px;">
      <button id="music-toggle" style="background:none;border:none;font-size:1.3em;cursor:pointer;color:#2d8cf0;">ğŸµ</button>
      <span style="font-size:1em;color:#2d8cf0;">èƒŒæ™¯éŸ³ä¹</span>
    </div>
    <!-- èŠå¤©æµ®çª— -->
    <div id="chat-float" style="position:fixed;bottom:90px;right:24px;z-index:9999;display:none;">
      <div id="chat-toggle" style="background:#2d8cf0;color:#fff;padding:10px 22px;border-radius:18px 18px 0 0;cursor:pointer;box-shadow:0 2px 8px #0002;font-size:1.1em;">ä¼šå‘˜èŠå¤© â–²</div>
      <div id="chat-window" style="display:none;width:320px;height:300px;max-width:95vw;max-height:80vh;min-width:280px;min-height:200px;background:#fff;border-radius:0 0 18px 18px;box-shadow:0 4px 24px #0002;position:relative;resize:both;overflow:hidden;">
        <div id="chat-header" style="background:#f0f7ff;padding:8px 12px;border-bottom:1px solid #e0eafc;display:flex;align-items:center;justify-content:space-between;">
          <div style="display:flex;align-items:center;gap:8px;">
            <button id="group-chat-btn" style="background:#2d8cf0;color:#fff;border:none;padding:4px 8px;border-radius:4px;font-size:0.9em;cursor:pointer;">ç¾¤èŠ</button>
            <button id="private-chat-btn" style="background:#ccc;color:#666;border:none;padding:4px 8px;border-radius:4px;font-size:0.9em;cursor:pointer;">ç§èŠ</button>
            <select id="private-user-select" style="display:none;padding:4px 8px;border:1px solid #ccc;border-radius:4px;font-size:0.9em;">
              <option value="">é€‰æ‹©ç§èŠç”¨æˆ·...</option>
            </select>
          </div>
        </div>
        <div id="chat-messages" style="height:calc(100% - 90px);overflow-y:auto;padding:12px 10px 6px 10px;font-size:1em;"></div>
        <form id="chat-form" style="display:flex;border-top:1px solid #e0eafc;position:absolute;bottom:0;left:0;right:0;background:#fff;">
          <button type="button" id="emoji-btn" style="background:none;border:none;font-size:1.3em;cursor:pointer;">ğŸ˜Š</button>
          <button type="button" id="img-btn" style="background:none;border:none;font-size:1.3em;cursor:pointer;">ğŸ–¼ï¸</button>
          <button type="button" id="video-btn" style="background:none;border:none;font-size:1.3em;cursor:pointer;">ğŸ“¹</button>
          <input id="chat-input" type="text" placeholder="è¾“å…¥èŠå¤©å†…å®¹..." maxlength="200" style="flex:1;padding:8px 10px;border:none;border-radius:0 0 0 18px;font-size:1em;outline:none;">
          <button type="submit" style="background:#2d8cf0;color:#fff;border:none;padding:0 18px;border-radius:0 0 18px 0;font-size:1em;cursor:pointer;">å‘é€</button>
          <input type="file" id="img-file" accept="image/*" style="display:none;">
        </form>
        <button id="fullscreen-btn" style="position:absolute;top:8px;right:8px;width:24px;height:24px;background:rgba(45,140,240,0.1);border:1px solid #2d8cf0;border-radius:4px;cursor:pointer;font-size:1.2em;color:#2d8cf0;display:flex;align-items:center;justify-content:center;transition:all 0.2s;" title="å…¨å±æ˜¾ç¤º" onmouseover="this.style.background='rgba(45,140,240,0.2)';this.style.transform='scale(1.1)'" onmouseout="this.style.background='rgba(45,140,240,0.1)';this.style.transform='scale(1)'">â›¶</button>
        <div id="resize-handle" style="position:absolute;bottom:2px;right:2px;width:12px;height:12px;cursor:se-resize;background:linear-gradient(45deg,transparent 30%,#ccc 30%,#ccc 40%,transparent 40%,transparent 60%,#ccc 60%,#ccc 70%,transparent 70%);border-radius:2px;"></div>
      </div>
    </div>
    <div id="emoji-panel" style="display:none;position:absolute;bottom:60px;right:24px;z-index:10000;background:#fff;border-radius:12px;box-shadow:0 2px 12px #0002;padding:8px 10px;max-width:320px;">
      <span style="font-size:1.3em;cursor:pointer;padding:4px;">ğŸ˜€</span>
      <span style="font-size:1.3em;cursor:pointer;padding:4px;">ğŸ˜‚</span>
      <span style="font-size:1.3em;cursor:pointer;padding:4px;">ğŸ˜</span>
      <span style="font-size:1.3em;cursor:pointer;padding:4px;">ğŸ˜</span>
      <span style="font-size:1.3em;cursor:pointer;padding:4px;">ğŸ˜­</span>
      <span style="font-size:1.3em;cursor:pointer;padding:4px;">ğŸ‘</span>
      <span style="font-size:1.3em;cursor:pointer;padding:4px;">ğŸ‰</span>
      <span style="font-size:1.3em;cursor:pointer;padding:4px;">ğŸ¥³</span>
      <span style="font-size:1.3em;cursor:pointer;padding:4px;">ğŸ˜¡</span>
      <span style="font-size:1.3em;cursor:pointer;padding:4px;">ğŸ¤”</span>
      <span style="font-size:1.3em;cursor:pointer;padding:4px;">ğŸ˜…</span>
      <span style="font-size:1.3em;cursor:pointer;padding:4px;">ğŸ˜</span>
    </div>
    <!-- è§†é¢‘é€šè¯å¼¹çª— -->
    <div id="video-call-modal" style="display:none;position:fixed;z-index:10001;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);align-items:center;justify-content:center;">
      <div style="background:#fff;padding:24px 18px;border-radius:12px;max-width:90vw;">
        <h3 style="margin:0 0 12px 0;">å‘èµ·è§†é¢‘é€šè¯</h3>
        <input id="video-peer-id" placeholder="å¯¹æ–¹ç”¨æˆ·å" style="padding:8px 12px;border-radius:6px;border:1px solid #ccc;">
        <button id="video-call-start" style="margin-left:10px;padding:8px 18px;border-radius:6px;background:#2d8cf0;color:#fff;border:none;">å‘¼å«</button>
        <button id="video-call-cancel" style="margin-left:10px;padding:8px 18px;border-radius:6px;background:#ccc;color:#333;border:none;">å–æ¶ˆ</button>
      </div>
    </div>
    <!-- è§†é¢‘çª—å£ -->
    <div id="video-chat-window" style="display:none;position:fixed;z-index:10002;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.8);align-items:center;justify-content:center;flex-direction:column;">
      <video id="local-video" autoplay muted playsinline style="width:320px;border-radius:12px;margin:10px 0;"></video>
      <video id="remote-video" autoplay playsinline style="width:320px;border-radius:12px;margin:10px 0;"></video>
      <button id="video-hangup" style="padding:10px 30px;border-radius:8px;background:#f44336;color:#fff;border:none;font-size:1.1em;">æŒ‚æ–­</button>
    </div>
    
    <!-- ä¼šå‘˜æ¸¸æˆå¹³å°å¼¹çª— -->
    <div id="member-games-modal" style="display:none;position:fixed;z-index:10003;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);justify-content:center;align-items:center;">
      <div style="background:#fff;border-radius:12px;box-shadow:0 4px 24px #0002;padding:24px;min-width:600px;max-width:90vw;max-height:80vh;overflow-y:auto;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
          <h2 style="margin:0;color:#2d8cf0;">ä¼šå‘˜æ¸¸æˆå¹³å°</h2>
          <button id="close-member-games" style="background:none;border:none;font-size:1.5em;cursor:pointer;color:#666;">Ã—</button>
        </div>
        <div id="member-games-list" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;">
          <!-- ä¼šå‘˜æ¸¸æˆåˆ—è¡¨ç”±JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div id="no-games-msg" style="text-align:center;color:#888;padding:40px 0;display:none;">
          æš‚æ— ä¼šå‘˜ä¸Šä¼ çš„æ¸¸æˆä½œå“
        </div>
      </div>
    </div>
    
    <!-- ä¸Šä¼ æ¸¸æˆå¼¹çª— -->
    <div id="upload-game-modal" style="display:none;position:fixed;z-index:10004;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);justify-content:center;align-items:center;">
      <div style="background:#fff;border-radius:12px;box-shadow:0 4px 24px #0002;padding:24px;min-width:400px;max-width:90vw;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
          <h2 style="margin:0;color:#f39c12;">ä¸Šä¼ æ¸¸æˆä½œå“</h2>
          <button id="close-upload-game" style="background:none;border:none;font-size:1.5em;cursor:pointer;color:#666;">Ã—</button>
        </div>
        <form id="upload-game-form">
          <div style="margin-bottom:16px;">
            <label style="display:block;margin-bottom:6px;font-weight:bold;">æ¸¸æˆåç§°ï¼š</label>
            <input id="game-name" type="text" required style="width:100%;padding:8px 12px;border:1px solid #ccc;border-radius:6px;font-size:1em;">
          </div>
          <div style="margin-bottom:16px;">
            <label style="display:block;margin-bottom:6px;font-weight:bold;">æ¸¸æˆæè¿°ï¼š</label>
            <textarea id="game-description" rows="3" required style="width:100%;padding:8px 12px;border:1px solid #ccc;border-radius:6px;font-size:1em;resize:vertical;"></textarea>
          </div>
          <div style="margin-bottom:16px;">
            <label style="display:block;margin-bottom:6px;font-weight:bold;">æ¸¸æˆé“¾æ¥ï¼š</label>
            <input id="game-url" type="url" required placeholder="https://..." style="width:100%;padding:8px 12px;border:1px solid #ccc;border-radius:6px;font-size:1em;">
          </div>
          <div style="margin-bottom:16px;">
            <label style="display:block;margin-bottom:6px;font-weight:bold;">æ¸¸æˆå›¾æ ‡ï¼š</label>
            <input id="game-icon" type="file" accept="image/*" style="width:100%;padding:8px 12px;border:1px solid #ccc;border-radius:6px;font-size:1em;">
            <div style="font-size:0.9em;color:#666;margin-top:4px;">æ”¯æŒjpgã€pngã€gifæ ¼å¼ï¼Œå»ºè®®å°ºå¯¸80x80px</div>
          </div>
          <div style="display:flex;gap:12px;">
            <button type="submit" style="flex:1;padding:10px 0;background:#f39c12;color:#fff;border:none;border-radius:6px;font-size:1em;font-weight:bold;cursor:pointer;">ä¸Šä¼ æ¸¸æˆ</button>
            <button type="button" id="cancel-upload" style="flex:1;padding:10px 0;background:#ccc;color:#333;border:none;border-radius:6px;font-size:1em;cursor:pointer;">å–æ¶ˆ</button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- æ›´å¤šæ¸¸æˆå¼¹çª— -->
    <div id="more-games-modal" style="display:none;position:fixed;z-index:10005;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);justify-content:center;align-items:center;">
      <div style="background:#fff;border-radius:12px;box-shadow:0 4px 24px #0002;padding:24px;min-width:600px;max-width:90vw;max-height:80vh;overflow-y:auto;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
          <h2 style="margin:0;color:#9c27b0;">æ›´å¤šç²¾å½©æ¸¸æˆ</h2>
          <button id="close-more-games" style="background:none;border:none;font-size:1.5em;cursor:pointer;color:#666;">Ã—</button>
        </div>
        <div id="more-games-list" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;">
          <!-- æ›´å¤šæ¸¸æˆåˆ—è¡¨ç”±JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
    </div>
    <div id="notice-btn" style="position:fixed;top:24px;left:24px;z-index:1000;"><button style="background:#2d8cf0;color:#fff;border:none;border-radius:8px;padding:8px 18px;font-size:1em;cursor:pointer;box-shadow:0 2px 8px #0002;">é€šçŸ¥</button></div>
    <div id="connection-test-btn" style="position:fixed;top:70px;left:24px;z-index:1000;">
      <button onclick="runConnectionTest()" style="background:#4caf50;color:#fff;border:none;border-radius:6px;padding:8px 12px;font-size:0.9em;cursor:pointer;">è¿æ¥æµ‹è¯•</button>
    </div>
    <div id="network-status" style="position:fixed;top:24px;right:24px;z-index:1000;padding:8px 12px;border-radius:6px;font-size:0.9em;display:none;">
      <span id="network-status-text"></span>
    </div>
    <div id="notice-modal" style="display:none;position:fixed;z-index:20001;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);justify-content:center;align-items:center;">
      <div style="background:#fff;border-radius:14px;box-shadow:0 4px 24px #0003;padding:32px 24px 18px 24px;max-width:95vw;max-height:90vh;overflow:auto;position:relative;min-width:320px;">
        <h2 style="margin:0 0 18px 0;text-align:center;color:#2d8cf0;">é€šçŸ¥å…¬å‘Š</h2>
        <div id="notice-list-view"></div>
        <button id="notice-close" style="position:absolute;top:18px;right:28px;background:none;border:none;font-size:2em;color:#2d8cf0;cursor:pointer;z-index:10;">Ã—</button>
      </div>
    </div>
    <script>
    // Supabaseé…ç½®ï¼ˆä¸adminä¸€è‡´ï¼‰
    const SUPABASE_URL = 'https://rfbjjgzmdtmvjxfbmvpm.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJmYmpqZ3ptZHRtdmp4ZmJtdnBtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyOTA1NjIsImV4cCI6MjA3Njg2NjU2Mn0.-WrayfzkBmfFWmEplWRI6RmxdZBGwU2H286QafsMQf0';

    // åˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯ï¼ˆå¦‚æœå¯ç”¨ï¼‰
    let supabaseClient = null;
    try {
      if (typeof supabase !== 'undefined') {
        const { createClient } = supabase;
        supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('Supabaseå®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ');
      } else {
        console.warn('Supabaseåº“æœªåŠ è½½ï¼Œç³»ç»Ÿå°†ä½¿ç”¨æœ¬åœ°å­˜å‚¨æ¨¡å¼');
      }
    } catch (error) {
      console.warn('Supabaseåˆå§‹åŒ–å¤±è´¥ï¼Œç³»ç»Ÿå°†ä½¿ç”¨æœ¬åœ°å­˜å‚¨æ¨¡å¼:', error);
    }

    // éªŒè¯ Supabase å®¢æˆ·ç«¯æ˜¯å¦æœ‰æƒé™å¯ç”¨ï¼›å¦‚é‡ 401 æˆ– æƒé™é”™è¯¯åˆ™å›é€€åˆ°æœ¬åœ°æ¨¡å¼
    async function validateSupabaseClient() {
      if (!supabaseClient) return false;
      try {
        const { data, error, status } = await supabaseClient.from('members').select('id').limit(1).maybeSingle();
        if (error) {
          console.warn('Supabase éªŒè¯å¤±è´¥:', error, 'status:', status);
          if (status === 401 || (error && String(error).toLowerCase().includes('jwt'))) {
            supabaseClient = null;
            console.warn('Supabase æˆæƒå¤±è´¥ï¼Œå›é€€åˆ°æœ¬åœ°å­˜å‚¨æ¨¡å¼');
            return false;
          }
        }
        return true;
      } catch (err) {
        console.warn('Supabase éªŒè¯å¼‚å¸¸ï¼Œå›é€€æœ¬åœ°:', err);
        supabaseClient = null;
        return false;
      }
    }

    (async ()=>{ await validateSupabaseClient(); })();
    // ä¼šå‘˜ç™»å½•/æ³¨å†Œé€»è¾‘
    const userBar = document.getElementById('user-bar');
    const loginBtn = document.getElementById('login-btn');
    const authModal = document.getElementById('auth-modal');
    const authForm = document.getElementById('auth-form');
    const authTitle = document.getElementById('auth-title');
    const toggleAuth = document.getElementById('toggle-auth');
    const authError = document.getElementById('auth-error');
    let isLoginMode = true;
    function getUsers() {
      return JSON.parse(localStorage.getItem('abc_users')||'{}');
    }
    function setUsers(users) {
      localStorage.setItem('abc_users', JSON.stringify(users));
    }
    async function supaFetchMembers() {
      if (!supabaseClient) return null;
      const { data, error } = await supabaseClient.from('members').select('username');
      if (error) { console.warn('è·å–Supabaseä¼šå‘˜å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨:', error.message); return null; }
      const users = {};
      (data||[]).forEach(r=>{ users[r.username]=true; });
      return users;
    }
    async function supaRegister(username, password) {
      if (!supabaseClient) return { success: false, error: 'Supabaseå®¢æˆ·ç«¯æœªåˆå§‹åŒ–' };
      const { data, error } = await supabaseClient.from('members').insert({ username, password });
      if (error) { 
        console.error('Supabaseæ³¨å†Œå¤±è´¥:', error);
        return { success: false, error: error.message, details: error };
      }
      return { success: true, data };
    }
    async function supaLogin(username, password) {
      if (!supabaseClient) return false;
      const { data, error } = await supabaseClient.from('members').select('id').eq('username', username).eq('password', password).maybeSingle();
      if (error) { console.warn('Supabaseç™»å½•æŸ¥è¯¢å¤±è´¥:', error.message); return false; }
      return !!data;
    }
    function getUserProfiles() {
      return JSON.parse(localStorage.getItem('abc_user_profiles')||'{}');
    }
    function setUserProfiles(profiles) {
      localStorage.setItem('abc_user_profiles', JSON.stringify(profiles));
    }
    function getUserProfile(username) {
      const profiles = getUserProfiles();
      return profiles[username] || {
        city: '',
        school: '',
        major: '',
        interests: ''
      };
    }
    function setUserProfile(username, profile) {
      const profiles = getUserProfiles();
      profiles[username] = profile;
      setUserProfiles(profiles);
    }
    function setCurrentUser(username) {
      localStorage.setItem('abc_current_user', username);
    }
    function getCurrentUser() {
      return localStorage.getItem('abc_current_user');
    }
    function logout() {
      localStorage.removeItem('abc_current_user');
      renderUserBar();
    }
    function renderUserBar() {
      const user = getCurrentUser();
      if (user) {
        userBar.innerHTML = `æ¬¢è¿ï¼Œ<b>${user}</b> | <span id="profile-btn" style="color:#fff;cursor:pointer;margin-right:10px;background-color:#2d8cf0;padding:4px 10px;border-radius:15px;font-weight:bold;">ä¼šå‘˜ä¿¡æ¯</span> | <span id="logout-btn" style="color:#fff;cursor:pointer;background-color:#f44336;padding:4px 10px;border-radius:15px;font-weight:bold;">é€€å‡ºç™»å½•</span>${user==='admin'?'<a href="admin.html" id="admin-link" style="margin-left:18px;color:#fff;background:#2d8cf0;padding:6px 16px;border-radius:18px;text-decoration:none;font-weight:bold;">åå°ç®¡ç†</a>':''}`;        
        document.getElementById('profile-btn').onclick = showProfileModal;
        document.getElementById('logout-btn').onclick = logout;
      } else {
        userBar.innerHTML = `<button id="login-btn" style="padding:6px 18px;border-radius:20px;background:#fff;color:#2d8cf0;border:none;cursor:pointer;font-weight:bold;box-shadow:0 2px 5px rgba(0,0,0,0.2);">ä¼šå‘˜æ³¨å†Œ/ç™»å½•</button>`;
        document.getElementById('login-btn').onclick = () => { authModal.style.display = 'flex'; };
      }
    }
    // å¹¿å‘Šç®¡ç†é€»è¾‘
    async function getAdData() {
      // ä¼˜å…ˆä½¿ç”¨æœ¬åœ°æ•°æ®ï¼ˆå¦‚æœ admin åœ¨æœ¬åœ°å·²å‘å¸ƒæˆ–æ–­ç½‘ï¼‰ï¼Œä»¥ä¿è¯æœ¬åœ°ä¸Šä¼ çš„å¹¿å‘Šå›¾ç‰‡èƒ½å³æ—¶æ˜¾ç¤º
      try {
        const rawLocal = JSON.parse(localStorage.getItem('abc_ads')||'{"banner":[],"footer":[]}');
        const hasLocal = (rawLocal && ((rawLocal.banner && rawLocal.banner.length>0) || (rawLocal.footer && rawLocal.footer.length>0)));
        const normalizeArr = (arr)=> (arr||[]).map(item=>{
          if(typeof item === 'string') { return { text: item, imgs: [] }; }
          if(item && typeof item === 'object') {
            return { text: (item.text||''), imgs: Array.isArray(item.imgs)? item.imgs : [] };
          }
          return { text: '', imgs: [] };
        });
        if (hasLocal) {
          return { banner: normalizeArr(rawLocal.banner), footer: normalizeArr(rawLocal.footer) };
        }
      } catch(e) {
        console.warn('è§£ææœ¬åœ° abc_ads å¤±è´¥ï¼Œç»§ç»­å°è¯• Supabase:', e);
      }

      // è‹¥æœ¬åœ°æ— æ•°æ®åˆ™å°è¯•ä» Supabase è¯»å–ï¼ˆå¦‚å¯ç”¨ï¼‰
      if(supabaseClient){
        try {
          const { data, error } = await supabaseClient.from('advertisements').select('*').order('created_at', { ascending: false });
          if(!error && data && data.length){
            const adData = { banner: [], footer: [] };
            data.forEach(ad => {
              const typeVal = ad.ad_type || ad.type; // å…¼å®¹ä¸¤ç§å­—æ®µ
              let imgs = ad.imgs;
              // imgs åœ¨æ•°æ®åº“ä¸­å¯èƒ½ä¸º JSON å­—ç¬¦ä¸²æˆ–æ•°ç»„ï¼Œæˆ– null
              if (typeof imgs === 'string') {
                try { imgs = JSON.parse(imgs); } catch (e) { imgs = imgs ? [imgs] : []; }
              }
              if (!Array.isArray(imgs)) imgs = imgs ? [imgs] : [];
              const obj = { text: ad.content || '', imgs: imgs.filter(Boolean) };
              if(typeVal === 'banner') adData.banner.push(obj);
              if(typeVal === 'footer') adData.footer.push(obj);
            });
            return adData;
          }
        } catch (err) {
          console.warn('ä» Supabase è·å–å¹¿å‘Šå¤±è´¥ï¼Œå›é€€æœ¬åœ°:', err);
        }
      }

      // æœ€ç»ˆå›é€€ï¼šç©ºæ•°æ®
      return { banner: [], footer: [] };
    }

    function setAdData(data) {
      localStorage.setItem('abc_ads', JSON.stringify(data));
    }
    // å¹¿å‘Šæ¸²æŸ“ï¼ˆå›¾ç‰‡+æ–‡å­—ï¼‰
    function renderAdItem(ad, padding, idx, type) {
      let html = '';
      if(ad.imgs && ad.imgs.length) {
        // ä¼˜å…ˆæ˜¾ç¤ºç¬¬ä¸€å¼ å›¾ç‰‡ä½œä¸ºç¼©ç•¥
        html += `<img src='${ad.imgs[0]}' style='max-height:60px;max-width:120px;margin-right:8px;border-radius:8px;vertical-align:middle;cursor:pointer;' data-adtype='${type}' data-adidx='${idx}' data-imgidx='0'>`;
      } else {
        // å ä½å›¾ï¼ˆçº¯æ–‡å­—å¹¿å‘Šæ—¶æ˜¾ç¤ºï¼‰
        html += `<div style='width:120px;height:60px;display:inline-flex;align-items:center;justify-content:center;background:#fff;border:1px dashed #cce4ff;border-radius:8px;color:#2d8cf0;font-size:0.95em;margin-right:8px;'>å¹¿å‘Šä½</div>`;
      }
      if(ad.text) {
        html += `<span style='vertical-align:middle;cursor:pointer;' data-adtype='${type}' data-adidx='${idx}'>${ad.text}</span>`;
      }
      return `<div style='padding:${padding};display:flex;align-items:center;gap:8px;justify-content:center;cursor:pointer;' data-adtype='${type}' data-adidx='${idx}'>${html}</div>`;
    }
    // è½®æ’­é€»è¾‘
    async function startAdCarousel(adData) {
      const adBannerDiv = document.getElementById('ad-banner-content');
      const adFooterDiv = document.getElementById('ad-footer-content');
      let adBannerIndex = 0, adFooterIndex = 0, adBannerTimer = null, adFooterTimer = null;
      // é¡¶éƒ¨å¹¿å‘Š
      if(adData.banner.length>1) {
        adBannerIndex = 0;
        if(window.adBannerTimer) clearInterval(window.adBannerTimer);
        adBannerDiv.innerHTML = renderAdItem(adData.banner[adBannerIndex], '2px 0', adBannerIndex, 'banner');
        window.adBannerTimer = setInterval(()=>{
          adBannerIndex = (adBannerIndex+1)%adData.banner.length;
          adBannerDiv.innerHTML = renderAdItem(adData.banner[adBannerIndex], '2px 0', adBannerIndex, 'banner');
        }, 3000);
      } else if(adData.banner.length===1) {
        if(window.adBannerTimer) clearInterval(window.adBannerTimer);
        adBannerDiv.innerHTML = renderAdItem(adData.banner[0], '2px 0', 0, 'banner');
      } else {
        if(window.adBannerTimer) clearInterval(window.adBannerTimer);
        adBannerDiv.innerHTML = '';
      }
      // åº•éƒ¨å¹¿å‘Š
      if(adData.footer.length>1) {
        adFooterIndex = 0;
        if(window.adFooterTimer) clearInterval(window.adFooterTimer);
        adFooterDiv.innerHTML = renderAdItem(adData.footer[adFooterIndex], '4px 0', adFooterIndex, 'footer');
        window.adFooterTimer = setInterval(()=>{
          adFooterIndex = (adFooterIndex+1)%adData.footer.length;
          adFooterDiv.innerHTML = renderAdItem(adData.footer[adFooterIndex], '4px 0', adFooterIndex, 'footer');
        }, 3000);
      } else if(adData.footer.length===1) {
        if(window.adFooterTimer) clearInterval(window.adFooterTimer);
        adFooterDiv.innerHTML = renderAdItem(adData.footer[0], '4px 0', 0, 'footer');
      } else {
        if(window.adFooterTimer) clearInterval(window.adFooterTimer);
        adFooterDiv.innerHTML = '';
      }
    }
    // é¦–æ¬¡å¹¿å‘Šæ¸²æŸ“ï¼Œå¼‚æ­¥
    (async()=>{await renderAds();})();
    // ä¿®æ”¹renderAdsï¼Œç¼–è¾‘å¹¿å‘Šåç«‹å³åˆ·æ–°è½®æ’­
    async function renderAds() {
      const adData = await getAdData();
      const adBannerDiv = document.getElementById('ad-banner-content');
      const adFooterDiv = document.getElementById('ad-footer-content');
      adBannerDiv.innerHTML = adData.banner.map((ad,i)=>renderAdItem(ad, '2px 0', i, 'banner')).join('');
      adFooterDiv.innerHTML = adData.footer.map((ad,i)=>renderAdItem(ad, '4px 0', i, 'footer')).join('');
      startAdCarousel(adData);
    }

    // å¹¿å‘Šè¯¦ç»†å¼¹çª—
    if(!document.getElementById('ad-detail-modal')) {
      const modal = document.createElement('div');
      modal.id = 'ad-detail-modal';
      modal.style = 'display:none;position:fixed;z-index:20000;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.45);justify-content:center;align-items:center;';
      modal.innerHTML = `<div id="ad-detail-content" style="background:#fff;border-radius:14px;box-shadow:0 4px 24px #0003;padding:32px 24px 18px 24px;max-width:95vw;max-height:90vh;overflow:auto;position:relative;text-align:center;"></div>`+
        `<button id="ad-detail-close" style="position:absolute;top:18px;right:28px;background:none;border:none;font-size:2em;color:#2d8cf0;cursor:pointer;z-index:10;">Ã—</button>`;
      document.body.appendChild(modal);
      document.getElementById('ad-detail-close').onclick = ()=>{ modal.style.display='none'; };
      modal.onclick = function(e){ if(e.target===modal) modal.style.display='none'; };
    }
    function showAdDetail(ad) {
      const modal = document.getElementById('ad-detail-modal');
      const content = document.getElementById('ad-detail-content');
      let imgsHtml = '';
      if(ad.imgs && ad.imgs.length) {
        imgsHtml = ad.imgs.map(img=>`<img src='${img}' style='max-width:90vw;max-height:50vh;margin:8px 0;border-radius:10px;box-shadow:0 2px 12px #0002;'>`).join('');
      }
      let textHtml = ad.text ? `<div style='margin:16px 0 0 0;font-size:1.2em;color:#2d8cf0;'>${ad.text}</div>` : '';
      content.innerHTML = imgsHtml + textHtml;
      modal.style.display = 'flex';
    }
    // äº‹ä»¶å§”æ‰˜ï¼šç‚¹å‡»å¹¿å‘Šæ å›¾ç‰‡æˆ–æ–‡å­—å¼¹çª—
    document.getElementById('ad-banner-content').onclick = document.getElementById('ad-footer-content').onclick = function(e) {
      let target = e.target;
      let adtype = target.getAttribute('data-adtype');
      let adidx = target.getAttribute('data-adidx');
      if(adtype && adidx!==null) {
        const adData = getAdData();
        const ad = adData[adtype][adidx];
        if(ad) showAdDetail(ad);
      }
    };
    // é¦–æ¬¡æ¸²æŸ“
    renderAds();
    renderUserBar();
    
    // ä¼šå‘˜æ¸¸æˆå¹³å°äº‹ä»¶ç›‘å¬
    document.getElementById('member-games-platform').onclick = showMemberGamesPlatform;
    document.getElementById('upload-game-btn').onclick = showUploadGameModal;
    document.getElementById('more-games-btn').onclick = showMoreGamesModal;
    
    // å¼¹çª—å…³é—­äº‹ä»¶
    document.getElementById('close-member-games').onclick = function() {
      document.getElementById('member-games-modal').style.display = 'none';
    };
    document.getElementById('close-upload-game').onclick = function() {
      document.getElementById('upload-game-modal').style.display = 'none';
    };
    document.getElementById('cancel-upload').onclick = function() {
      document.getElementById('upload-game-modal').style.display = 'none';
    };
    document.getElementById('close-more-games').onclick = function() {
      document.getElementById('more-games-modal').style.display = 'none';
    };
    
    // ä¸Šä¼ æ¸¸æˆè¡¨å•æäº¤
    document.getElementById('upload-game-form').onsubmit = handleGameUpload;
    
    // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
    document.getElementById('member-games-modal').onclick = function(e) {
      if (e.target === this) this.style.display = 'none';
    };
    document.getElementById('upload-game-modal').onclick = function(e) {
      if (e.target === this) this.style.display = 'none';
    };
    document.getElementById('more-games-modal').onclick = function(e) {
      if (e.target === this) this.style.display = 'none';
    };
    loginBtn.onclick = () => { authModal.style.display = 'flex'; };
    authModal.onclick = e => { if(e.target===authModal) authModal.style.display='none'; };
    toggleAuth.onclick = () => {
      isLoginMode = !isLoginMode;
      authTitle.textContent = isLoginMode ? 'ä¼šå‘˜ç™»å½•' : 'ä¼šå‘˜æ³¨å†Œ';
      authForm.querySelector('button[type=submit]').textContent = isLoginMode ? 'ç™»å½•' : 'æ³¨å†Œ';
      toggleAuth.textContent = isLoginMode ? 'æ²¡æœ‰è´¦å·ï¼Ÿæ³¨å†Œ' : 'å·²æœ‰è´¦å·ï¼Ÿç™»å½•';
      authError.style.display = 'none';
    };
    authForm.onsubmit = async e => {
      e.preventDefault();
      const username = document.getElementById('auth-username').value.trim();
      const password = document.getElementById('auth-password').value;
      if (!username || !password) return;
      let users = getUsers();
      if (isLoginMode) {
        // ç‰¹æ®Šå¤„ç†adminç”¨æˆ·ç™»å½•
        if (username === 'admin') {
          // æ£€æŸ¥æ˜¯å¦ä¸ºé»˜è®¤å¯†ç 
          if (password === 'admin123') {
            setCurrentUser(username);
            authModal.style.display = 'none';
            renderUserBar();
            return;
          }
          // å¦‚æœä¸æ˜¯é»˜è®¤å¯†ç ï¼Œæ£€æŸ¥æœ¬åœ°å­˜å‚¨
          if (!users[username] || users[username] !== password) {
            authError.textContent = 'ç®¡ç†å‘˜å¯†ç é”™è¯¯ï¼Œé»˜è®¤å¯†ç ä¸ºï¼šadmin123';
            authError.style.display = 'block';
            return;
          }
        } else {
          // ä¼˜å…ˆå°è¯•Supabaseç™»å½•
          let ok = false;
          if (supabaseClient) {
            ok = await supaLogin(username, password);
          }
          // å›é€€æœ¬åœ°
          if (!ok) {
            if (!users[username] || users[username] !== password) {
              authError.textContent = 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯';
              authError.style.display = 'block';
              return;
            }
          }
        }
        setCurrentUser(username);
        authModal.style.display = 'none';
        renderUserBar();
      } else {
        // æ³¨å†Œï¼šå…ˆå°è¯•Supabase
        if (supabaseClient) {
          // æ£€æŸ¥é‡å
          const { data: exists, error: exErr } = await supabaseClient.from('members').select('id').eq('username', username).maybeSingle();
          if (exErr) { 
            console.warn('æ£€æŸ¥ç”¨æˆ·åå¤±è´¥:', exErr.message);
            authError.textContent = `æ£€æŸ¥ç”¨æˆ·åå¤±è´¥: ${exErr.message}`;
            authError.style.display = 'block';
            return;
          }
          if (exists) {
            authError.textContent = 'ç”¨æˆ·åå·²å­˜åœ¨';
            authError.style.display = 'block';
            return;
          }
          
          // å°è¯•æ³¨å†Œ
          const result = await supaRegister(username, password);
          if (!result.success) {
            // æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
            let errorMsg = 'æ³¨å†Œå¤±è´¥';
            if (result.error) {
              errorMsg += ': ' + result.error;
              // å¦‚æœæ¶‰åŠæƒé™é—®é¢˜ï¼Œç»™å‡ºæç¤º
              if (result.error.includes('permission') || result.error.includes('RLS') || result.error.includes('policy')) {
                errorMsg += '\n\næç¤ºï¼šå¯èƒ½æ˜¯æ•°æ®åº“æƒé™é—®é¢˜ï¼Œè¯·è”ç³»ç®¡ç†å‘˜æ£€æŸ¥RLSç­–ç•¥è®¾ç½®ã€‚';
              }
            }
            authError.textContent = errorMsg;
            authError.style.display = 'block';
            console.error('æ³¨å†Œå¤±è´¥è¯¦æƒ…:', result.details);
            return;
          }
          // æ³¨å†ŒæˆåŠŸï¼ŒåŒæ—¶ä¿å­˜åˆ°æœ¬åœ°
          users[username] = password;
          setUsers(users);
        } else {
          if (users[username]) {
            authError.textContent = 'ç”¨æˆ·åå·²å­˜åœ¨';
            authError.style.display = 'block';
            return;
          }
          users[username] = password;
          setUsers(users);
        }
        setCurrentUser(username);
        // åˆå§‹åŒ–ç”¨æˆ·èµ„æ–™
        setUserProfile(username, {
          city: '',
          school: '',
          major: '',
          interests: ''
        });
        authModal.style.display = 'none';
        renderUserBar();
      }
    };
    
    // ä¼šå‘˜ä¿¡æ¯ç®¡ç†åŠŸèƒ½
    const profileModal = document.getElementById('member-profile-modal');
    const profileForm = document.getElementById('member-profile-form');
    const profileError = document.getElementById('profile-error');
    const profileSuccess = document.getElementById('profile-success');
    
    function showProfileModal() {
      const username = getCurrentUser();
      if (!username) return;
      
      // å¡«å……ç”¨æˆ·å
      document.getElementById('profile-username').value = username;
      
      // æ¸…ç©ºå¯†ç å­—æ®µ
      document.getElementById('profile-old-password').value = '';
      document.getElementById('profile-new-password').value = '';
      document.getElementById('profile-confirm-password').value = '';
      
      // åŠ è½½ç”¨æˆ·èµ„æ–™
      const profile = getUserProfile(username);
      document.getElementById('profile-city').value = profile.city || '';
      document.getElementById('profile-school').value = profile.school || '';
      document.getElementById('profile-major').value = profile.major || '';
      document.getElementById('profile-interests').value = profile.interests || '';
      
      // æ¸…ç©ºé”™è¯¯å’ŒæˆåŠŸä¿¡æ¯
      profileError.style.display = 'none';
      profileSuccess.style.display = 'none';
      
      // æ˜¾ç¤ºå¼¹çª—
      profileModal.style.display = 'flex';
    }
    
    // å…³é—­ä¼šå‘˜ä¿¡æ¯ç®¡ç†å¼¹çª—
    document.getElementById('cancel-profile').onclick = function() {
      profileModal.style.display = 'none';
    };
    
    // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
    profileModal.onclick = function(e) {
      if (e.target === this) this.style.display = 'none';
    };
    
    // æäº¤ä¼šå‘˜ä¿¡æ¯è¡¨å•
    profileForm.onsubmit = function(e) {
      e.preventDefault();
      const username = document.getElementById('profile-username').value;
      const oldPassword = document.getElementById('profile-old-password').value;
      const newPassword = document.getElementById('profile-new-password').value;
      const confirmPassword = document.getElementById('profile-confirm-password').value;
      const city = document.getElementById('profile-city').value.trim();
      const school = document.getElementById('profile-school').value.trim();
      const major = document.getElementById('profile-major').value.trim();
      const interests = document.getElementById('profile-interests').value.trim();
      
      // æ¸…ç©ºé”™è¯¯å’ŒæˆåŠŸä¿¡æ¯
      profileError.style.display = 'none';
      profileSuccess.style.display = 'none';
      
      // æ›´æ–°ç”¨æˆ·èµ„æ–™
      const profile = {
        city: city,
        school: school,
        major: major,
        interests: interests
      };
      setUserProfile(username, profile);
      
      // å¦‚æœå¡«å†™äº†å¯†ç å­—æ®µï¼Œåˆ™æ›´æ”¹å¯†ç 
      if (oldPassword || newPassword || confirmPassword) {
        // éªŒè¯æ‰€æœ‰å¯†ç å­—æ®µéƒ½å·²å¡«å†™
        if (!oldPassword || !newPassword || !confirmPassword) {
          profileError.textContent = 'è¯·å¡«å†™æ‰€æœ‰å¯†ç å­—æ®µ';
          profileError.style.display = 'block';
          return;
        }
        
        // éªŒè¯æ—§å¯†ç æ˜¯å¦æ­£ç¡®
        const users = getUsers();
        if (users[username] !== oldPassword) {
          profileError.textContent = 'å½“å‰å¯†ç ä¸æ­£ç¡®';
          profileError.style.display = 'block';
          return;
        }
        
        // éªŒè¯æ–°å¯†ç å’Œç¡®è®¤å¯†ç æ˜¯å¦ä¸€è‡´
        if (newPassword !== confirmPassword) {
          profileError.textContent = 'æ–°å¯†ç å’Œç¡®è®¤å¯†ç ä¸ä¸€è‡´';
          profileError.style.display = 'block';
          return;
        }
        
        // æ›´æ–°å¯†ç 
        users[username] = newPassword;
        setUsers(users);
        
        // æ¸…ç©ºå¯†ç å­—æ®µ
        document.getElementById('profile-old-password').value = '';
        document.getElementById('profile-new-password').value = '';
        document.getElementById('profile-confirm-password').value = '';
        
        profileSuccess.textContent = 'å¯†ç å·²æ›´æ”¹ï¼Œä¸ªäººä¿¡æ¯å·²ä¿å­˜';
      } else {
        profileSuccess.textContent = 'ä¸ªäººä¿¡æ¯å·²ä¿å­˜';
      }
      
      profileSuccess.style.display = 'block';
    };
    // èƒŒæ™¯éŸ³ä¹æ§åˆ¶
    const bgMusic = document.getElementById('bg-music');
    const musicToggle = document.getElementById('music-toggle');
    let musicPlaying = false;
    function playMusic() {
      bgMusic.volume = 0.5;
      bgMusic.play().catch(()=>{});
      musicToggle.textContent = 'ğŸ”Š';
      musicPlaying = true;
    }
    function pauseMusic() {
      bgMusic.pause();
      musicToggle.textContent = 'ğŸµ';
      musicPlaying = false;
    }
    musicToggle.onclick = () => {
      if (musicPlaying) pauseMusic(); else playMusic();
    };
    // è‡ªåŠ¨æ’­æ”¾ï¼ˆéœ€ç”¨æˆ·é¦–æ¬¡äº¤äº’ï¼‰
    window.addEventListener('click', function autoPlayOnce(){
      if (!musicPlaying) playMusic();
      window.removeEventListener('click', autoPlayOnce);
    });
    // é¡µé¢åˆ‡æ¢è‡ªåŠ¨æš‚åœ/æ¢å¤
    document.addEventListener('visibilitychange',()=>{
      if(document.hidden) pauseMusic(); else if(getCurrentUser()) playMusic();
    });
    // èŠå¤©çª—å£é€»è¾‘
    function getCurrentUser() { return localStorage.getItem('abc_current_user'); }
    function getChatMsgs() { return JSON.parse(localStorage.getItem('abc_chat_msgs')||'[]'); }
    function setChatMsgs(msgs) { localStorage.setItem('abc_chat_msgs', JSON.stringify(msgs)); }
    
    // ç§èŠåŠŸèƒ½
    let currentChatMode = 'group';
    let currentPrivateUser = '';
    
    function getPrivateChatMsgs(targetUser) {
      const key = `abc_private_chat_${getCurrentUser()}_${targetUser}`;
      return JSON.parse(localStorage.getItem(key)||'[]');
    }
    
    function setPrivateChatMsgs(targetUser, msgs) {
      const key = `abc_private_chat_${getCurrentUser()}_${targetUser}`;
      localStorage.setItem(key, JSON.stringify(msgs));
    }
    
    function getAllUsersLocal() {
      const users = JSON.parse(localStorage.getItem('abc_users')||'{}');
      const currentUser = getCurrentUser();
      return Object.keys(users).filter(user => user !== currentUser && user !== 'admin');
    }

    async function updateUserSelect() {
      const select = document.getElementById('private-user-select');
      let users = [];
      if (supabaseClient) {
        const { data, error } = await supabaseClient.from('members').select('username');
        if (!error && data) {
          const me = getCurrentUser();
          users = data.map(r=>r.username).filter(u=>u!==me && u!=='admin');
        }
      }
      if (!users.length) {
        users = getAllUsersLocal();
      }
      select.innerHTML = '<option value="">é€‰æ‹©ç§èŠç”¨æˆ·...</option>' + 
        users.map(user => `<option value="${user}">${user}</option>`).join('');
    }
    
    function switchChatMode(mode) {
      currentChatMode = mode;
      const groupBtn = document.getElementById('group-chat-btn');
      const privateBtn = document.getElementById('private-chat-btn');
      const userSelect = document.getElementById('private-user-select');
      
      if (mode === 'group') {
        groupBtn.style.background = '#2d8cf0';
        groupBtn.style.color = '#fff';
        privateBtn.style.background = '#ccc';
        privateBtn.style.color = '#666';
        userSelect.style.display = 'none';
        currentPrivateUser = '';
        renderChatMsgs();
      } else {
        groupBtn.style.background = '#ccc';
        groupBtn.style.color = '#666';
        privateBtn.style.background = '#2d8cf0';
        privateBtn.style.color = '#fff';
        userSelect.style.display = 'block';
        updateUserSelect();
      }
    }
    
    function onPrivateUserChange() {
      const select = document.getElementById('private-user-select');
      currentPrivateUser = select.value;
      
      if (currentPrivateUser) {
        renderChatMsgs();
      }
    }
    
    // èŠå¤©çª—å£å¤§å°è°ƒæ•´åŠŸèƒ½
    function getChatWindowSize() {
      const saved = localStorage.getItem('abc_chat_window_size');
      return saved ? JSON.parse(saved) : {width: 320, height: 300};
    }
    function setChatWindowSize(size) {
      localStorage.setItem('abc_chat_window_size', JSON.stringify(size));
    }
    function getChatFullscreenState() {
      return localStorage.getItem('abc_chat_fullscreen') === 'true';
    }
    function setChatFullscreenState(isFullscreen) {
      localStorage.setItem('abc_chat_fullscreen', isFullscreen.toString());
    }
    
    function initChatWindowResize() {
      const chatWindow = document.getElementById('chat-window');
      const resizeHandle = document.getElementById('resize-handle');
      const fullscreenBtn = document.getElementById('fullscreen-btn');
      const savedSize = getChatWindowSize();
      const isFullscreen = getChatFullscreenState();
      
      if (isFullscreen) {
        enterFullscreen();
      } else {
        chatWindow.style.width = savedSize.width + 'px';
        chatWindow.style.height = savedSize.height + 'px';
      }
      
      let isResizing = false;
      let startX, startY, startWidth, startHeight;
      
      fullscreenBtn.onclick = function() {
        const currentFullscreen = getChatFullscreenState();
        if (currentFullscreen) {
          exitFullscreen();
        } else {
          enterFullscreen();
        }
      };
      
      function enterFullscreen() {
        chatWindow.style.width = '95vw';
        chatWindow.style.height = '80vh';
        chatWindow.style.maxWidth = '95vw';
        chatWindow.style.maxHeight = '80vh';
        resizeHandle.style.display = 'none';
        fullscreenBtn.textContent = 'â›¶';
        fullscreenBtn.title = 'é€€å‡ºå…¨å±';
        setChatFullscreenState(true);
      }
      
      function exitFullscreen() {
        chatWindow.style.width = savedSize.width + 'px';
        chatWindow.style.height = savedSize.height + 'px';
        chatWindow.style.maxWidth = '95vw';
        chatWindow.style.maxHeight = '80vh';
        resizeHandle.style.display = 'block';
        fullscreenBtn.textContent = 'â›¶';
        fullscreenBtn.title = 'å…¨å±æ˜¾ç¤º';
        setChatFullscreenState(false);
      }
      
      resizeHandle.onmousedown = function(e) {
        e.preventDefault();
        isResizing = true;
        startX = e.clientX;
        startY = e.clientY;
        startWidth = parseInt(chatWindow.style.width);
        startHeight = parseInt(chatWindow.style.height);
        
        document.body.style.cursor = 'se-resize';
        document.body.style.userSelect = 'none';
      };
      
      document.onmousemove = function(e) {
        if (!isResizing) return;
        
        const deltaX = e.clientX - startX;
        const deltaY = e.clientY - startY;
        
        let newWidth = startWidth + deltaX;
        let newHeight = startHeight + deltaY;
        
        newWidth = Math.max(280, Math.min(newWidth, window.innerWidth * 0.95));
        newHeight = Math.max(200, Math.min(newHeight, window.innerHeight * 0.8));
        
        chatWindow.style.width = newWidth + 'px';
        chatWindow.style.height = newHeight + 'px';
      };
      
      document.onmouseup = function() {
        if (isResizing) {
          isResizing = false;
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
          
          const newSize = {
            width: parseInt(chatWindow.style.width),
            height: parseInt(chatWindow.style.height)
          };
          setChatWindowSize(newSize);
        }
      };
    }
    
    async function fetchChatMsgsFromSupabase() {
      if (!supabaseClient) return null;
      if (currentChatMode === 'group') {
        const { data, error } = await supabaseClient.from('messages').select('*').eq('scope','group').order('created_at', { ascending: true });
        if (error) { console.warn('è·å–ç¾¤èŠå¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°:', error.message); return null; }
        return (data||[]).map(m=>({ user:m.username, time:m.time_text, text:m.text, img:m.img }));
      } else if (currentPrivateUser) {
        const me = getCurrentUser();
        const { data, error } = await supabaseClient.from('messages').select('*').eq('scope','private').in('chat_pair',[`${me}|${currentPrivateUser}`,`${currentPrivateUser}|${me}`]).order('created_at',{ascending:true});
        if (error) { console.warn('è·å–ç§èŠå¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°:', error.message); return null; }
        return (data||[]).map(m=>({ user:m.username, time:m.time_text, text:m.text, img:m.img }));
      }
      return [];
    }

    async function renderChatMsgs() {
      let msgs = [];
      const remote = await fetchChatMsgsFromSupabase();
      if (remote) {
        msgs = remote;
      } else {
        if (currentChatMode === 'group') {
          msgs = getChatMsgs();
        } else if (currentPrivateUser) {
          msgs = getPrivateChatMsgs(currentPrivateUser);
        }
      }
      const msgDiv = document.getElementById('chat-messages');
      msgDiv.innerHTML = msgs.map(m=>{
        let content = '';
        if(m.text) content += `<span style='word-break:break-all;'>${m.text}</span>`;
        if(m.img) content += `<br><img src='${m.img}' style='max-width:120px;max-height:90px;border-radius:8px;cursor:pointer;' class='chat-img'>`;
        return `<div style='margin-bottom:8px;'><b style='color:#2d8cf0;'>${m.user}</b> <span style='color:#888;font-size:0.9em;'>${m.time}</span><br>${content}</div>`;
      }).join('');
      msgDiv.scrollTop = msgDiv.scrollHeight;
      msgDiv.querySelectorAll('.chat-img').forEach(img=>{
        img.onclick = function(e){
          e.stopPropagation();
          showImgPreview(img.src);
        };
      });
    }
    function showChatFloat() {
      document.getElementById('chat-float').style.display = 'block';
    }
    function hideChatFloat() {
      document.getElementById('chat-float').style.display = 'none';
    }
    function toggleChatWindow() {
      const win = document.getElementById('chat-window');
      const toggle = document.getElementById('chat-toggle');
      if(win.style.display==='none') { win.style.display='block'; toggle.innerHTML='ä¼šå‘˜èŠå¤© â–¼'; renderChatMsgs(); }
      else { win.style.display='none'; toggle.innerHTML='ä¼šå‘˜èŠå¤© â–²'; }
    }
    if(getCurrentUser()) {
      showChatFloat();
      initChatWindowResize();
      
      document.getElementById('group-chat-btn').onclick = function() {
        switchChatMode('group');
      };
      document.getElementById('private-chat-btn').onclick = function() {
        switchChatMode('private');
      };
      
      document.getElementById('private-user-select').onchange = onPrivateUserChange;
    }
    document.getElementById('chat-toggle').onclick = toggleChatWindow;
    document.getElementById('chat-form').onsubmit = async function(e){
      e.preventDefault();
      const input = document.getElementById('chat-input');
      const text = input.value.trim();
      if(!text) return;
      const now = new Date();
      const timeStr = now.getFullYear()+"-"+(now.getMonth()+1)+"-"+now.getDate()+" "+now.getHours()+":"+String(now.getMinutes()).padStart(2,'0');
      const message = {
        user: getCurrentUser(),
        time: timeStr,
        text: text
      };
      let sentRemote = false;
      if (supabaseClient) {
        if (currentChatMode === 'group') {
          const { error } = await supabaseClient.from('messages').insert({ scope:'group', username: message.user, text: message.text, img: null, time_text: message.time });
          if (!error) sentRemote = true; else console.warn('ç¾¤èŠæ¶ˆæ¯è¿œç¨‹ä¿å­˜å¤±è´¥ï¼Œæ”¹ç”¨æœ¬åœ°:', error.message);
        } else if (currentPrivateUser) {
          const pair = `${message.user}|${currentPrivateUser}`;
          const { error } = await supabaseClient.from('messages').insert({ scope:'private', chat_pair: pair, username: message.user, text: message.text, img: null, time_text: message.time });
          if (!error) sentRemote = true; else console.warn('ç§èŠæ¶ˆæ¯è¿œç¨‹ä¿å­˜å¤±è´¥ï¼Œæ”¹ç”¨æœ¬åœ°:', error.message);
        }
      }
      if (!sentRemote) {
        if (currentChatMode === 'group') {
          const msgs = getChatMsgs();
          msgs.push(message);
          setChatMsgs(msgs.slice(-100));
        } else if (currentPrivateUser) {
          const msgs = getPrivateChatMsgs(currentPrivateUser);
          msgs.push(message);
          setPrivateChatMsgs(currentPrivateUser, msgs.slice(-100));
        }
      }
      input.value = '';
      renderChatMsgs();
    };
    window.addEventListener('storage', function(e){ 
      if(e.key==='abc_chat_msgs') {
        if (currentChatMode === 'group') {
          renderChatMsgs();
        }
      } else if (e.key && e.key.startsWith('abc_private_chat_')) {
        if (currentChatMode === 'private' && currentPrivateUser) {
          renderChatMsgs();
        }
      }
    });
    // è¡¨æƒ…é¢æ¿é€»è¾‘
    const emojiBtn = document.getElementById('emoji-btn');
    const emojiPanel = document.getElementById('emoji-panel');
    const chatInput = document.getElementById('chat-input');
    emojiBtn.onclick = function(e) {
      e.stopPropagation();
      emojiPanel.style.display = emojiPanel.style.display==='none' ? 'block' : 'none';
    };
    document.body.addEventListener('click', function(){ emojiPanel.style.display='none'; });
    emojiPanel.onclick = function(e){
      if(e.target.tagName==='SPAN') {
        insertAtCursor(chatInput, e.target.textContent);
        emojiPanel.style.display='none';
        chatInput.focus();
      }
    };
    function insertAtCursor(input, text) {
      if(document.selection) {
        input.focus();
        var sel = document.selection.createRange();
        sel.text = text;
      } else if(input.selectionStart || input.selectionStart === 0) {
        let start = input.selectionStart;
        let end = input.selectionEnd;
        input.value = input.value.substring(0, start) + text + input.value.substring(end);
        input.selectionStart = input.selectionEnd = start + text.length;
      } else {
        input.value += text;
      }
    }
    // å›¾ç‰‡æŒ‰é’®é€»è¾‘
    const imgBtn = document.getElementById('img-btn');
    const imgFile = document.getElementById('img-file');
    imgBtn.onclick = function(){ imgFile.click(); };
    imgFile.onchange = function(){
      const file = imgFile.files[0];
      if(!file) return;
      if(!file.type.match(/^image\/(jpeg|png|gif)$/)) { alert('ä»…æ”¯æŒjpg/png/gifå›¾ç‰‡'); return; }
      if(file.size > 2*1024*1024) { alert('å›¾ç‰‡ä¸èƒ½è¶…è¿‡2MB'); return; }
      const reader = new FileReader();
      reader.onload = function(e){
        sendChatImg(e.target.result);
      };
      reader.readAsDataURL(file);
    };
    async function sendChatImg(imgData) {
      const now = new Date();
      const timeStr = now.getFullYear()+"-"+(now.getMonth()+1)+"-"+now.getDate()+" "+now.getHours()+":"+String(now.getMinutes()).padStart(2,'0');
      const message = {
        user: getCurrentUser(),
        time: timeStr,
        text: document.getElementById('chat-input').value.trim(),
        img: imgData
      };
      let sentRemote = false;
      if (supabaseClient) {
        if (currentChatMode === 'group') {
          const { error } = await supabaseClient.from('messages').insert({ scope:'group', username: message.user, text: message.text||null, img: message.img, time_text: message.time });
          if (!error) sentRemote = true; else console.warn('ç¾¤èŠå›¾ç‰‡æ¶ˆæ¯è¿œç¨‹ä¿å­˜å¤±è´¥ï¼Œæ”¹ç”¨æœ¬åœ°:', error.message);
        } else if (currentPrivateUser) {
          const pair = `${message.user}|${currentPrivateUser}`;
          const { error } = await supabaseClient.from('messages').insert({ scope:'private', chat_pair: pair, username: message.user, text: message.text||null, img: message.img, time_text: message.time });
          if (!error) sentRemote = true; else console.warn('ç§èŠå›¾ç‰‡æ¶ˆæ¯è¿œç¨‹ä¿å­˜å¤±è´¥ï¼Œæ”¹ç”¨æœ¬åœ°:', error.message);
        }
      }
      if (!sentRemote) {
        if (currentChatMode === 'group') {
          const msgs = getChatMsgs();
          msgs.push(message);
          setChatMsgs(msgs.slice(-100));
        } else if (currentPrivateUser) {
          const msgs = getPrivateChatMsgs(currentPrivateUser);
          msgs.push(message);
          setPrivateChatMsgs(currentPrivateUser, msgs.slice(-100));
        }
      }
      document.getElementById('chat-input').value = '';
      renderChatMsgs();
    }
    // Realtime è®¢é˜…
    (function setupRealtime(){
      if (!supabaseClient) return;
      try {
        supabaseClient.channel('realtime:messages')
          .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
            // æ–°æ¶ˆæ¯åˆ°è¾¾æ—¶åˆ·æ–°ï¼ˆå°½é‡è½»é‡ï¼Œä»…åœ¨çª—å£æ‰“å¼€æ—¶ï¼‰
            const win = document.getElementById('chat-window');
            if (win && win.style.display!== 'none') {
              renderChatMsgs();
            }
          })
          .subscribe();
      } catch (e) { console.warn('è®¢é˜…Realtimeå¤±è´¥:', e); }
    })();
    // å›¾ç‰‡é¢„è§ˆå¼¹çª—
    let imgPreviewDiv = null;
    function showImgPreview(src) {
      if(imgPreviewDiv) imgPreviewDiv.remove();
      imgPreviewDiv = document.createElement('div');
      imgPreviewDiv.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);z-index:20000;display:flex;align-items:center;justify-content:center;';
      imgPreviewDiv.innerHTML = `<img src='${src}' style='max-width:90vw;max-height:90vh;border-radius:12px;box-shadow:0 4px 24px #000a;'>`;
      imgPreviewDiv.onclick = function(){ imgPreviewDiv.remove(); };
      document.body.appendChild(imgPreviewDiv);
    }
    // ç½‘ç»œè¿æ¥æ£€æµ‹å’ŒçŠ¶æ€æ˜¾ç¤º
    function updateNetworkStatus() {
      const statusDiv = document.getElementById('network-status');
      const statusText = document.getElementById('network-status-text');
      
      if (!navigator.onLine) {
        statusDiv.style.display = 'block';
        statusDiv.style.background = '#f44336';
        statusDiv.style.color = '#fff';
        statusText.textContent = 'ç½‘ç»œè¿æ¥å·²æ–­å¼€';
        console.warn('ç½‘ç»œè¿æ¥å·²æ–­å¼€ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨');
        return false;
      } else {
        statusDiv.style.display = 'none';
        return true;
      }
    }
    
    function checkNetworkConnection() {
      return updateNetworkStatus();
    }
    
    // ç›‘å¬ç½‘ç»œçŠ¶æ€å˜åŒ–
    window.addEventListener('online', updateNetworkStatus);
    window.addEventListener('offline', updateNetworkStatus);
    
    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç½‘ç»œçŠ¶æ€
    updateNetworkStatus();
    
    // é”™è¯¯è¯Šæ–­å’Œæ¢å¤ç³»ç»Ÿ
    function diagnoseConnectionError(error) {
      const errorMessage = error.toString().toLowerCase();
      let diagnosis = '';
      let solution = '';
      
      if (errorMessage.includes('resource_exhausted')) {
        diagnosis = 'èµ„æºè€—å°½é”™è¯¯';
        solution = 'æœåŠ¡å™¨èµ„æºä¸è¶³ï¼Œè¯·ç¨åé‡è¯•æˆ–æ£€æŸ¥VPNè®¾ç½®';
      } else if (errorMessage.includes('network') || errorMessage.includes('connection')) {
        diagnosis = 'ç½‘ç»œè¿æ¥é”™è¯¯';
        solution = 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–VPNè®¾ç½®';
      } else if (errorMessage.includes('timeout')) {
        diagnosis = 'è¿æ¥è¶…æ—¶';
        solution = 'ç½‘ç»œå“åº”ç¼“æ…¢ï¼Œè¯·æ£€æŸ¥ç½‘ç»œé€Ÿåº¦æˆ–VPNè®¾ç½®';
      } else if (errorMessage.includes('cors')) {
        diagnosis = 'è·¨åŸŸè¯·æ±‚é”™è¯¯';
        solution = 'æµè§ˆå™¨å®‰å…¨ç­–ç•¥é˜»æ­¢äº†è¯·æ±‚';
      } else {
        diagnosis = 'æœªçŸ¥è¿æ¥é”™è¯¯';
        solution = 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒVPNè®¾ç½®';
      }
      
      return { diagnosis, solution };
    }
    
    // æ˜¾ç¤ºé”™è¯¯è¯Šæ–­ä¿¡æ¯
    function showErrorDiagnosis(error) {
      const { diagnosis, solution } = diagnoseConnectionError(error);
      const errorMsg = `è¿æ¥é”™è¯¯è¯Šæ–­ï¼š\n\né”™è¯¯ç±»å‹ï¼š${diagnosis}\n\nå»ºè®®è§£å†³æ–¹æ¡ˆï¼š\n${solution}\n\nç³»ç»Ÿå°†è‡ªåŠ¨åˆ‡æ¢åˆ°ç¦»çº¿æ¨¡å¼ï¼Œæ‰€æœ‰åŠŸèƒ½ä»å¯æ­£å¸¸ä½¿ç”¨ã€‚`;
      alert(errorMsg);
      console.error('è¿æ¥é”™è¯¯è¯¦æƒ…:', error);
    }
    
    // å…¨å±€é”™è¯¯æ•è·
    window.addEventListener('error', function(event) {
      if (event.error && event.error.toString().includes('resource_exhausted')) {
        showErrorDiagnosis(event.error);
      }
    });
    
    // æœªå¤„ç†çš„Promiseæ‹’ç»æ•è·
    window.addEventListener('unhandledrejection', function(event) {
      if (event.reason && event.reason.toString().includes('resource_exhausted')) {
        showErrorDiagnosis(event.reason);
        event.preventDefault(); // é˜»æ­¢é»˜è®¤çš„é”™è¯¯å¤„ç†
      }
    });
    
    // è¿æ¥æµ‹è¯•åŠŸèƒ½
    async function runConnectionTest() {
      const testBtn = document.querySelector('#connection-test-btn button');
      const originalText = testBtn.textContent;
      testBtn.textContent = 'æµ‹è¯•ä¸­...';
      testBtn.disabled = true;
      
      const results = [];
      
      // æµ‹è¯•SupabaseæœåŠ¡è¿æ¥ï¼ˆè¿™æ˜¯æ ¸å¿ƒåŠŸèƒ½ï¼Œæœ€å…³é”®ï¼‰
      try {
        const startTime = Date.now();
        await fetch('https://rfbjjgzmdtmvjxfbmvpm.supabase.co/rest/v1/', {
          method: 'HEAD',
          mode: 'no-cors',
          cache: 'no-cache'
        });
        const responseTime = Date.now() - startTime;
        results.push(`âœ“ SupabaseæœåŠ¡è¿æ¥æ­£å¸¸ (${responseTime}ms)`);
        results.push(`âœ“ åŸºæœ¬ç½‘ç»œè¿æ¥æ­£å¸¸ï¼ˆé€šè¿‡Supabaseæµ‹è¯•ï¼‰`);
      } catch (error) {
        results.push(`âœ— SupabaseæœåŠ¡è¿æ¥å¤±è´¥: ${error.message}`);
        results.push(`âš  ç½‘ç»œè¿æ¥å¯èƒ½å­˜åœ¨é—®é¢˜ï¼Œè¯·æ£€æŸ¥ç½‘ç»œç¯å¢ƒ`);
      }
      
      // æµ‹è¯•PeerJSæœåŠ¡
      try {
        const startTime = Date.now();
        await fetch('https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js', {
          method: 'HEAD',
          mode: 'no-cors',
          cache: 'no-cache'
        });
        const responseTime = Date.now() - startTime;
        results.push(`âœ“ PeerJSæœåŠ¡è¿æ¥æ­£å¸¸ (${responseTime}ms)`);
      } catch (error) {
        results.push(`âœ— PeerJSæœåŠ¡è¿æ¥å¤±è´¥: ${error.message}`);
      }
      
      // æµ‹è¯•CDNèµ„æº
      try {
        const startTime = Date.now();
        await fetch('https://unpkg.com/@supabase/supabase-js@2', {
          method: 'HEAD',
          mode: 'no-cors',
          cache: 'no-cache'
        });
        const responseTime = Date.now() - startTime;
        results.push(`âœ“ CDNèµ„æºè®¿é—®æ­£å¸¸ (${responseTime}ms)`);
      } catch (error) {
        results.push(`âœ— CDNèµ„æºè®¿é—®å¤±è´¥: ${error.message}`);
      }
      
      // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
      const hasErrors = results.some(r => r.includes('âœ—') || r.includes('âš '));
      const resultText = `ç½‘ç»œè¿æ¥æµ‹è¯•ç»“æœï¼š\n\n${results.join('\n')}\n\nè¯´æ˜ï¼š\n${hasErrors ? 
        'â€¢ SupabaseæœåŠ¡æ­£å¸¸ï¼Œæ ¸å¿ƒåŠŸèƒ½å¯ç”¨\nâ€¢ å¦‚æœåŸºæœ¬ç½‘ç»œæµ‹è¯•å¤±è´¥ï¼Œå¯èƒ½æ˜¯æµ‹è¯•æ–¹æ³•é™åˆ¶ï¼Œä¸å½±å“å®é™…ä½¿ç”¨\nâ€¢ å¦‚ä»æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥VPNè®¾ç½®æˆ–ç½‘ç»œç¯å¢ƒ' : 
        'â€¢ æ‰€æœ‰è¿æ¥æµ‹è¯•é€šè¿‡ï¼Œç½‘ç»œçŠ¶å†µè‰¯å¥½'}`;
      
      alert(resultText);
      
      testBtn.textContent = originalText;
      testBtn.disabled = false;
    }
    
    // PeerJS è§†é¢‘é€šè¯é›†æˆ
    let peer = null, currentCall = null;
    function setupPeerVideo() {
      const user = getCurrentUser();
      if(!user) return;
      if(peer) return;
      
      // æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒPeerJSåº“
      if (!checkNetworkConnection()) {
        console.warn('ç½‘ç»œè¿æ¥ä¸å¯ç”¨ï¼Œè§†é¢‘é€šè¯åŠŸèƒ½å·²ç¦ç”¨');
        return;
      }
      
      if (typeof Peer === 'undefined') {
        console.warn('PeerJSåº“æœªåŠ è½½ï¼Œè§†é¢‘é€šè¯åŠŸèƒ½ä¸å¯ç”¨');
        return;
      }
      
      try {
        const uniqueId = `${user}-${Math.random().toString(36).slice(2,8)}`;
        peer = new Peer(uniqueId, { debug: 2 });
        peer.on('open', id => { 
          console.log('PeerJSè¿æ¥æˆåŠŸï¼Œç”¨æˆ·ID:', id);
        });
        peer.on('error', error => {
          console.error('PeerJSè¿æ¥é”™è¯¯:', error);
          if (String(error && error.message || '').includes('is taken')) {
            // IDå ç”¨æ—¶é‡è¯•ä¸€æ¬¡
            try {
              const retryId = `${user}-${Math.random().toString(36).slice(2,8)}`;
              peer?.destroy();
              peer = new Peer(retryId, { debug: 2 });
              peer.on('open', id => console.log('PeerJSé‡è¯•æˆåŠŸï¼Œç”¨æˆ·ID:', id));
              peer.on('error', err => console.error('PeerJSé‡è¯•ä»å¤±è´¥:', err));
            } catch (e) {
              console.error('PeerJSé‡è¯•åˆå§‹åŒ–å¤±è´¥:', e);
            }
          } else {
            alert('è§†é¢‘é€šè¯æœåŠ¡è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•');
          }
        });
        peer.on('call', async call => {
          if(!confirm('æ”¶åˆ°è§†é¢‘é€šè¯è¯·æ±‚ï¼Œæ˜¯å¦æ¥å¬ï¼Ÿ')) return;
          try {
            const localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
            document.getElementById('local-video').srcObject = localStream;
            document.getElementById('video-chat-window').style.display = 'flex';
            call.answer(localStream);
            currentCall = call;
            call.on('stream', remoteStream => {
              document.getElementById('remote-video').srcObject = remoteStream;
            });
            call.on('close', endVideoCall);
          } catch (error) {
            console.error('è·å–æ‘„åƒå¤´æƒé™å¤±è´¥:', error);
            alert('æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
          }
        });
        // é¡µé¢å…³é—­æ—¶é”€æ¯peerï¼Œé‡Šæ”¾ID
        window.addEventListener('beforeunload', () => { try { peer && peer.destroy(); } catch (e) {} });
      } catch (error) {
        console.error('PeerJSåˆå§‹åŒ–å¤±è´¥:', error);
        alert('è§†é¢‘é€šè¯åŠŸèƒ½åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
      }
    }
    if(getCurrentUser()) setupPeerVideo();
    const videoBtn = document.getElementById('video-btn');
    const videoCallModal = document.getElementById('video-call-modal');
    videoBtn.onclick = function() {
      videoCallModal.style.display = 'flex';
    };
    document.getElementById('video-call-cancel').onclick = function() {
      videoCallModal.style.display = 'none';
    };
    document.getElementById('video-call-start').onclick = async function() {
      const remoteId = document.getElementById('video-peer-id').value.trim();
      if(!remoteId) return alert('è¯·è¾“å…¥å¯¹æ–¹ç”¨æˆ·å');
      
      if (!peer) {
        alert('è§†é¢‘é€šè¯æœåŠ¡æœªå°±ç»ªï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
        return;
      }
      
      videoCallModal.style.display = 'none';
      startVideoCall(remoteId);
    };
    async function startVideoCall(remoteId) {
      try {
        const localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
        document.getElementById('local-video').srcObject = localStream;
        document.getElementById('video-chat-window').style.display = 'flex';
        currentCall = peer.call(remoteId, localStream);
        currentCall.on('stream', remoteStream => {
          document.getElementById('remote-video').srcObject = remoteStream;
        });
        currentCall.on('close', endVideoCall);
        currentCall.on('error', error => {
          console.error('è§†é¢‘é€šè¯é”™è¯¯:', error);
          alert('è§†é¢‘é€šè¯è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
          endVideoCall();
        });
      } catch (error) {
        console.error('å¯åŠ¨è§†é¢‘é€šè¯å¤±è´¥:', error);
        alert('æ— æ³•å¯åŠ¨è§†é¢‘é€šè¯ï¼Œè¯·æ£€æŸ¥æ‘„åƒå¤´æƒé™å’Œç½‘ç»œè¿æ¥');
      }
    }
    document.getElementById('video-hangup').onclick = endVideoCall;
    function endVideoCall() {
      document.getElementById('video-chat-window').style.display = 'none';
      if(currentCall) currentCall.close();
      document.getElementById('local-video').srcObject = null;
      document.getElementById('remote-video').srcObject = null;
    }
    // ä¼šå‘˜æ¸¸æˆå¹³å°åŠŸèƒ½
    function getMemberGames() {
      return JSON.parse(localStorage.getItem('abc_member_games')||'[]');
    }
    
    function setMemberGames(games) {
      localStorage.setItem('abc_member_games', JSON.stringify(games));
    }
    
    function renderMemberGames() {
      const games = getMemberGames();
      const gamesList = document.getElementById('member-games-list');
      const noGamesMsg = document.getElementById('no-games-msg');
      
      if (games.length === 0) {
        gamesList.style.display = 'none';
        noGamesMsg.style.display = 'block';
        return;
      }
      
      gamesList.style.display = 'grid';
      noGamesMsg.style.display = 'none';
      
      gamesList.innerHTML = games.map(game => `
        <div style="background:#f7faff;border-radius:8px;padding:16px;text-align:center;border:1px solid #e0eafc;">
          <img src="${game.icon || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjRjBGNUZGIi8+Cjx0ZXh0IHg9IjQwIiB5PSI0NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSIjMkQ4Q0YwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj7lm77niYfliqDovb08L3RleHQ+Cjwvc3ZnPgo='}" 
               alt="${game.name}" style="width:60px;height:60px;object-fit:cover;border-radius:8px;margin-bottom:8px;">
          <div style="font-weight:bold;margin-bottom:4px;color:#2d8cf0;">${game.name}</div>
          <div style="font-size:0.9em;color:#666;margin-bottom:8px;line-height:1.3;">${game.description}</div>
          <div style="font-size:0.8em;color:#888;margin-bottom:8px;">ä½œè€…: ${game.author}</div>
          <a href="${game.url}" target="_blank" style="display:inline-block;padding:6px 12px;background:#2d8cf0;color:#fff;text-decoration:none;border-radius:4px;font-size:0.9em;">å¼€å§‹æ¸¸æˆ</a>
        </div>
      `).join('');
    }
    
    function showMemberGamesPlatform() {
      if (!getCurrentUser()) {
        alert('è¯·å…ˆç™»å½•ä¼šå‘˜è´¦å·');
        return;
      }
      renderMemberGames();
      document.getElementById('member-games-modal').style.display = 'flex';
    }
    
    function showUploadGameModal() {
      if (!getCurrentUser()) {
        alert('è¯·å…ˆç™»å½•ä¼šå‘˜è´¦å·');
        return;
      }
      document.getElementById('upload-game-modal').style.display = 'flex';
    }
    
    function handleGameUpload(e) {
      e.preventDefault();
      
      const gameName = document.getElementById('game-name').value.trim();
      const gameDescription = document.getElementById('game-description').value.trim();
      const gameUrl = document.getElementById('game-url').value.trim();
      const gameIconFile = document.getElementById('game-icon').files[0];
      
      if (!gameName || !gameDescription || !gameUrl) {
        alert('è¯·å¡«å†™å®Œæ•´çš„æ¸¸æˆä¿¡æ¯');
        return;
      }
      
      let iconData = '';
      if (gameIconFile) {
        const reader = new FileReader();
        reader.onload = function(e) {
          iconData = e.target.result;
          saveGame(gameName, gameDescription, gameUrl, iconData);
        };
        reader.readAsDataURL(gameIconFile);
      } else {
        saveGame(gameName, gameDescription, gameUrl, iconData);
      }
    }
    
    function saveGame(name, description, url, icon) {
      const games = getMemberGames();
      const newGame = {
        id: Date.now(),
        name: name,
        description: description,
        url: url,
        icon: icon,
        author: getCurrentUser(),
        uploadTime: new Date().toLocaleString()
      };
      
      games.push(newGame);
      setMemberGames(games);
      
      document.getElementById('upload-game-form').reset();
      document.getElementById('upload-game-modal').style.display = 'none';
      
      alert('æ¸¸æˆä¸Šä¼ æˆåŠŸï¼');
    }
    // é€šçŸ¥å¼¹çª—é€»è¾‘
    // ä¼˜å…ˆä» Supabase è¯»å–ï¼ˆå¦‚æœå®¢æˆ·ç«¯å¯ç”¨ä¸”æœ‰æƒé™ï¼‰ï¼Œå¦åˆ™å›é€€åˆ° localStorage
    // è¾…åŠ©ï¼šè§„èŒƒåŒ–é€šçŸ¥çš„ img å­—æ®µï¼ˆæ”¯æŒæ•°ç»„ã€JSON å­—ç¬¦ä¸²æˆ–å•ä¸ªå­—ç¬¦ä¸²ï¼‰
    function normalizeNoticeImg(img){
      if(!img) return '';
      // å·²æ˜¯æ•°ç»„
      if(Array.isArray(img)) return img.length?img[0]:'';
      // å­—ç¬¦ä¸²ï¼Œå¯èƒ½æ˜¯ JSON æ•°ç»„æˆ–å•å­—ç¬¦ä¸²
      if(typeof img === 'string'){
        const s = img.trim();
        if(!s) return '';
        // å°è¯•è§£æ JSON æ•°ç»„å­—ç¬¦ä¸²
        if((s.startsWith('[') && s.endsWith(']')) || s.startsWith('"[')){
          try{ const parsed = JSON.parse(s); if(Array.isArray(parsed)) return parsed.length?parsed[0]:''; }catch(e){ /* ignore */ }
        }
        return s;
      }
      // å…¶ä»–ç±»å‹ï¼Œè¿”å›ç©º
      return '';
    }
    async function fetchNotices() {
      if (supabaseClient) {
        try {
          const { data, error } = await supabaseClient.from('notices').select('content, img, time').order('created_at', { ascending: false });
          if (!error && data) {
            return (data||[]).map(n => ({ text: n.content || '', img: normalizeNoticeImg(n.img), time: n.time || '' }));
          }
        } catch (err) {
          console.warn('ä» Supabase è·å–é€šçŸ¥å¤±è´¥ï¼Œå›é€€æœ¬åœ°ï¼š', err);
        }
      }
      // å›é€€åˆ°æœ¬åœ°
      // æœ¬åœ°æ•°æ®å¯èƒ½åŒ…å« img å­—æ®µæˆ–æ•°ç»„ï¼Œç»Ÿä¸€å¤„ç†
      try{
        const local = JSON.parse(localStorage.getItem('abc_notices')||'[]');
        return (local||[]).map(n=>({ text: n.text||'', img: normalizeNoticeImg(n.img||n.imgs||''), time: n.time||'' }));
      }catch(e){ return []; }
    }

    function renderNoticeListView() {
      const list = document.getElementById('notice-list-view');
      fetchNotices().then(notices => {
        if(!notices || !notices.length) {
          list.innerHTML = '<div style="color:#888;text-align:center;padding:40px 0;">æš‚æ— é€šçŸ¥</div>';
          return;
        }
        // æ¸²æŸ“å¹¶ä¸ºæ¯æ¡é€šçŸ¥ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼ˆå›¾ç‰‡é¢„è§ˆ/è¯¦æƒ…ï¼‰
  list.innerHTML = notices.map((n,i)=>`<div class='notice-list-item' data-idx='${i}' style='border-bottom:1px solid #e0eafc;padding:16px 0;display:flex;align-items:center;gap:18px;cursor:pointer;'>${n.img?`<img src='${n.img}' class='notice-thumb' data-idx='${i}' style='width:60px;height:60px;object-fit:cover;border-radius:8px;border:1px solid #e0eafc;flex-shrink:0;margin-right:8px;' onerror="this.style.display='none';console.warn('é€šçŸ¥å›¾ç‰‡åŠ è½½å¤±è´¥: ', this.src)">`:''}<div style='flex:1;'><div class='notice-text' style='font-size:1.1em;color:#2d8cf0;margin-bottom:6px;'>${n.text||''}</div><div class='notice-time' style='font-size:0.9em;color:#888;'>${n.time||''}</div></div></div>`).join('');
        // ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼šç‚¹å‡»å›¾ç‰‡æˆ–æ¡ç›®æ˜¾ç¤ºè¯¦æƒ…
        Array.from(list.querySelectorAll('.notice-thumb')).forEach(img=>{
          img.onclick = function(e){
            e.stopPropagation();
            const idx = +this.dataset.idx;
            showNoticeDetail(notices[idx]);
          };
        });
        Array.from(list.querySelectorAll('.notice-list-item')).forEach(item=>{
          item.onclick = function(){
            const idx = +this.dataset.idx;
            showNoticeDetail(notices[idx]);
          };
        });
      }).catch(err=>{
        console.error('æ¸²æŸ“é€šçŸ¥åˆ—è¡¨å¤±è´¥ï¼š', err);
        list.innerHTML = '<div style="color:#888;text-align:center;padding:40px 0;">æš‚æ— é€šçŸ¥</div>';
      });
    }
    // é€šçŸ¥è¯¦æƒ…å¼¹çª—ï¼ˆå›¾ç‰‡é¢„è§ˆæˆ–æ–‡æœ¬è¯¦æƒ…ï¼‰
    if(!document.getElementById('notice-detail-modal')){
      const nmodal = document.createElement('div');
      nmodal.id = 'notice-detail-modal';
      nmodal.style = 'display:none;position:fixed;z-index:20002;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.45);justify-content:center;align-items:center;';
      nmodal.innerHTML = `<div id='notice-detail-content' style='background:#fff;border-radius:14px;box-shadow:0 4px 24px #0003;padding:24px;max-width:90vw;max-height:80vh;overflow:auto;position:relative;text-align:center;'></div>`+
        `<button id='notice-detail-close' style='position:absolute;top:12px;right:18px;background:none;border:none;font-size:2em;color:#2d8cf0;cursor:pointer;z-index:10;'>Ã—</button>`;
      document.body.appendChild(nmodal);
      document.getElementById('notice-detail-close').onclick = ()=>{ nmodal.style.display='none'; };
      nmodal.onclick = function(e){ if(e.target===nmodal) nmodal.style.display='none'; };
    }
    function showNoticeDetail(notice){
      const modal = document.getElementById('notice-detail-modal');
      const content = document.getElementById('notice-detail-content');
      let imgsHtml = '';
      if(notice.img){
        imgsHtml = `<img src='${notice.img}' style='max-width:90vw;max-height:60vh;border-radius:10px;margin-bottom:12px;box-shadow:0 2px 12px rgba(0,0,0,0.15);'>`;
      }
      const textHtml = notice.text?`<div style='font-size:1.1em;color:#2d8cf0;margin-top:8px;'>${notice.text}</div>`:'';
      const timeHtml = notice.time?`<div style='font-size:0.9em;color:#888;margin-top:6px;'>${notice.time}</div>`:'';
      content.innerHTML = imgsHtml + textHtml + timeHtml;
      modal.style.display = 'flex';
    }
    document.getElementById('notice-btn').onclick = function(){
      renderNoticeListView();
      document.getElementById('notice-modal').style.display = 'flex';
    };
    document.getElementById('notice-close').onclick = function(){
      document.getElementById('notice-modal').style.display = 'none';
    };
    document.getElementById('notice-modal').onclick = function(e){
      if(e.target===this) this.style.display='none';
    };
    // é¦–é¡µé€šçŸ¥æ¨ªå‘æ»šåŠ¨æ¡ï¼ˆä» Supabase æˆ–æœ¬åœ°è¯»å–ï¼‰
    function renderNoticeMarquee() {
      const marquee = document.getElementById('notice-marquee');
      if(!marquee) return;
      fetchNotices().then(notices => {
        const texts = (notices||[]).map(n=>n.text).filter(Boolean);
        if(!texts.length) {
          marquee.textContent = 'æš‚æ— é€šçŸ¥';
          return;
        }
        marquee.textContent = texts.join('    |    ');
        let pos = document.getElementById('notice-marquee-wrap').offsetWidth;
        marquee.style.left = pos + 'px';
        function step() {
          pos -= 1;
          marquee.style.left = pos + 'px';
          if(pos + marquee.offsetWidth < 0) {
            pos = document.getElementById('notice-marquee-wrap').offsetWidth;
          }
          marquee._marqueeTimer = requestAnimationFrame(step);
        }
        if(marquee._marqueeTimer) cancelAnimationFrame(marquee._marqueeTimer);
        step();
      }).catch(err=>{
        console.warn('è·å–é€šçŸ¥å¤±è´¥ï¼Œå›é€€æœ¬åœ°ï¼š', err);
        marquee.textContent = 'æš‚æ— é€šçŸ¥';
      });
    }
    renderNoticeMarquee();

    // å®šæœŸä» Supabase åŒæ­¥æ•°æ®åˆ° localStorageï¼ˆä½¿åå°å˜æ›´å°½å¿«åæ˜ åˆ°å‰ç«¯ï¼‰
    async function syncFromSupabase(){
      if(!supabaseClient) return;
      try{
        // åŒæ­¥å¹¿å‘Š
        const { data: adsData, error: adsErr } = await supabaseClient.from('advertisements').select('ad_type,type,content,imgs,created_at').order('created_at', { ascending: false }).limit(50);
        if(!adsErr && adsData){
          // å½’ä¸€åŒ–ä¸ºæœ¬åœ°ç»“æ„
          const local = { banner: [], footer: [] };
          (adsData||[]).forEach(a=>{
            const imgs = (typeof a.imgs==='string' ? (()=>{ try{ const p=JSON.parse(a.imgs); return Array.isArray(p)?p: [a.imgs]; }catch(e){ return [a.imgs]; } })() : (Array.isArray(a.imgs)?a.imgs: (a.imgs? [a.imgs] : [])));
            const item = { text: a.content||'', imgs: imgs };
            if((a.ad_type||a.type)=='footer') local.footer.push(item); else local.banner.push(item);
          });
          localStorage.setItem('abc_ads', JSON.stringify(local));
          // è§¦å‘æ¸²æŸ“
          if(typeof renderAds === 'function') renderAds();
        }

        // åŒæ­¥é€šçŸ¥
        const { data: noticeData, error: noticeErr } = await supabaseClient.from('notices').select('content,img,time,created_at').order('created_at', { ascending: false }).limit(50);
        if(!noticeErr && noticeData){
          const normalized = (noticeData||[]).map(n=>({ text: n.content||'', img: n.img||'', time: n.time||'', created_at: n.created_at }));
          localStorage.setItem('abc_notices', JSON.stringify(normalized));
          // æ›´æ–°è·‘é©¬å’Œæ¨¡æ€åˆ—è¡¨
          if(typeof renderNoticeMarquee === 'function') renderNoticeMarquee();
          if(document.getElementById('notice-modal') && document.getElementById('notice-modal').style.display==='flex' && typeof renderNoticeListView === 'function') renderNoticeListView();
        }

        // åŒæ­¥èŠå¤©æ¶ˆæ¯ï¼ˆå¦‚æœè¡¨åä¸åŒè¯·ä¿®æ”¹ï¼‰
        const { data: msgsData, error: msgsErr } = await supabaseClient.from('messages').select('user, text, img, time').order('created_at', { ascending: false }).limit(200);
        if(!msgsErr && msgsData){
          const msgs = (msgsData||[]).map(m=>({ user: m.user||'guest', text: m.text||'', img: m.img||'', time: m.time||'' })).reverse();
          localStorage.setItem('abc_chat_msgs', JSON.stringify(msgs));
          if(typeof renderChatMsgs === 'function') renderChatMsgs();
        }
      }catch(err){ console.warn('åŒæ­¥ Supabase å¤±è´¥ï¼š', err); }
    }

    // é¡µé¢åŠ è½½åå¦‚æœ supabase å¯ç”¨åˆ™ç«‹å³åŒæ­¥ä¸€æ¬¡å¹¶æ¯30ç§’åŒæ­¥
    (function(){ if(supabaseClient){ syncFromSupabase(); setInterval(syncFromSupabase, 30000); } })();
    window.addEventListener('storage', function(e){
      if(e.key==='abc_notices') renderNoticeMarquee();
    });
    
    // æ›´å¤šæ¸¸æˆåŠŸèƒ½
    function showMoreGamesModal() {
      renderMoreGames();
      document.getElementById('more-games-modal').style.display = 'flex';
    }
    
    function renderMoreGames() {
      const moreGamesList = document.getElementById('more-games-list');
      const games = [
        {
          name: 'å¤ªç©ºå°„å‡»æ¸¸æˆ',
          description: 'ç»å…¸å¤ªç©ºå°„å‡»æ¸¸æˆï¼Œæ¶ˆç­å¤–æ˜Ÿæ•Œäººï¼Œä¿å«åœ°çƒï¼',
          url: 'æ›´å¤š/å¤ªç©ºå°„å‡»æ¸¸æˆ/å¤ªç©ºå°„å‡»æ¸¸æˆ.html',
          icon: 'æ›´å¤š/å¤ªç©ºå°„å‡»æ¸¸æˆ/å¤ªç©ºå°„å‡»æ¸¸æˆ.png'
        },
        {
          name: 'é©¬é‡Œå¥¥èµ›è½¦',
          description: 'ç»å…¸é©¬é‡Œå¥¥èµ›è½¦æ¸¸æˆï¼Œä½“éªŒé€Ÿåº¦ä¸æ¿€æƒ…çš„ç«é€Ÿä¹è¶£ï¼',
          url: 'æ›´å¤š/é©¬é‡Œå¥¥èµ›è½¦/index.html',
          icon: 'æ›´å¤š/é©¬é‡Œå¥¥èµ›è½¦/é©¬é‡Œå¥¥èµ›è½¦.png'
        },
        {
          name: 'é…·è·‘æ¸¸æˆ',
          description: 'åˆºæ¿€çš„è·‘é…·æ¸¸æˆï¼Œè·³è·ƒã€æ»‘è¡Œï¼ŒæŒ‘æˆ˜å„ç§éšœç¢ï¼',
          url: 'æ›´å¤š/é…·è·‘æ¸¸æˆ/è·‘é…·æ¸¸æˆ.html',
          icon: 'æ›´å¤š/é…·è·‘æ¸¸æˆ/é…·è·‘æ¸¸æˆ.png'
        }
      ];
      
      moreGamesList.innerHTML = games.map(game => `
        <div style="background:#f7faff;border-radius:8px;padding:12px;text-align:center;border:1px solid #e0eafc;transition:transform 0.2s, box-shadow 0.2s;cursor:pointer;" onmouseover="this.style.transform='translateY(-2px) scale(1.01)';this.style.boxShadow='0 2px 8px rgba(156,39,176,0.15)'" onmouseout="this.style.transform='translateY(0) scale(1)';this.style.boxShadow='none'">
          <img src="${game.icon}" 
               alt="${game.name}" style="width:60px;height:60px;object-fit:cover;border-radius:8px;margin-bottom:8px;box-shadow:0 1px 4px rgba(0,0,0,0.1);">
          <div style="font-weight:bold;margin-bottom:4px;color:#9c27b0;font-size:1em;">${game.name}</div>
          <div style="font-size:0.85em;color:#666;margin-bottom:8px;line-height:1.3;">${game.description}</div>
          <a href="${game.url}" target="_blank" style="display:inline-block;padding:6px 12px;background:#9c27b0;color:#fff;text-decoration:none;border-radius:4px;font-size:0.85em;font-weight:bold;transition:background 0.2s;" onmouseover="this.style.background='#7b1fa2'" onmouseout="this.style.background='#9c27b0'">å¼€å§‹æ¸¸æˆ</a>
        </div>
      `).join('');
    }
    </script>
</body>
</html> 