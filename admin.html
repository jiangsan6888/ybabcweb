<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>延边ABC后台管理</title>
  <link rel="icon" href="延边ABC Logo.png">
  <style>
    body { font-family: 'Microsoft YaHei', Arial, sans-serif; background: #f5f8fc; margin:0; }
    .admin-header { background:#2d8cf0; color:#fff; padding:24px 0 18px 0; text-align:center; font-size:2em; letter-spacing:2px; }
    .admin-main { display:flex; max-width:1100px; margin:30px auto; background:#fff; border-radius:16px; box-shadow:0 4px 24px #2d8cf011; min-height:500px; }
    .admin-menu { width:200px; border-right:1px solid #e0eafc; background:#f7faff; border-radius:16px 0 0 16px; padding:0; }
    .admin-menu ul { list-style:none; margin:0; padding:0; }
    .admin-menu li { padding:22px 0 22px 0; text-align:center; font-size:1.15em; color:#2d8cf0; cursor:pointer; border-bottom:1px solid #e0eafc; transition:background 0.2s; }
    .admin-menu li.active, .admin-menu li:hover { background:#e0eafc; font-weight:bold; }
    .admin-content { flex:1; padding:36px 32px; }
    .admin-section { display:none; }
    .admin-section.active { display:block; }
    .admin-table { width:100%; border-collapse:collapse; margin-top:18px; }
    .admin-table th, .admin-table td { border:1px solid #e0eafc; padding:10px 8px; text-align:center; }
    .admin-table th { background:#f7faff; color:#2d8cf0; }
    .btn { background:#2d8cf0; color:#fff; border:none; border-radius:6px; padding:5px 16px; cursor:pointer; font-size:1em; }
    .btn[disabled] { background:#ccc; cursor:not-allowed; }
    .logout-bar { text-align:right; margin:0 0 18px 0; }
    .logout-bar button { background:none; border:none; color:#2d8cf0; font-size:1em; cursor:pointer; }
    textarea { width:100%; min-height:60px; border-radius:6px; border:1px solid #ccc; padding:8px; font-size:1em; }
    .save-bar { text-align:right; margin-top:10px; }
  </style>
</head>
<body>
  <div class="admin-header">延边ABC后台管理系统</div>
    <div id="connection-test-btn" style="position:fixed;top:24px;left:24px;z-index:1000;">
      <button onclick="runConnectionTest()" style="background:#4caf50;color:#fff;border:none;border-radius:6px;padding:8px 12px;font-size:0.9em;cursor:pointer;">连接测试</button>
    </div>
    <div id="admin-network-status" style="position:fixed;top:24px;right:24px;z-index:1000;padding:8px 12px;border-radius:6px;font-size:0.9em;display:none;">
      <span id="admin-network-status-text"></span>
    </div>
  <div class="admin-main">
    <nav class="admin-menu">
      <ul>
        <li class="active" data-section="member">会员管理</li>
        <li data-section="ad">广告管理</li>
        <li data-section="chat">聊天管理</li>
        <li data-section="notice">通知管理</li>
      </ul>
    </nav>
    <div class="admin-content">
      <div class="logout-bar"><button id="admin-logout">退出后台</button></div>
      <div id="section-member" class="admin-section active">
        <h2>会员管理</h2>
        <div style="margin-bottom: 10px;">
          <button id="refresh-members" class="btn" style="background: #4caf50;">刷新会员列表</button>
        </div>
        <table class="admin-table" id="member-table">
          <thead><tr><th>用户名</th><th>操作</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="section-ad" class="admin-section">
        <h2>广告管理</h2>
        <form id="ad-form">
          <div style="margin-bottom:14px;">
            <label>顶部广告：</label>
            <div id="ad-banner-list"></div>
            <button type="button" id="add-banner-ad" class="btn" style="margin-top:8px;">新增顶部广告</button>
          </div>
          <div style="margin-bottom:14px;">
            <label>底部广告：</label>
            <div id="ad-footer-list"></div>
            <button type="button" id="add-footer-ad" class="btn" style="margin-top:8px;">新增底部广告</button>
          </div>
          <div class="save-bar"><button type="submit" class="btn">保存广告</button></div>
        </form>
      </div>
      <div id="section-chat" class="admin-section">
        <h2>聊天管理</h2>
        <div style="margin-bottom: 10px;">
          <button id="refresh-chat" class="btn" style="background: #4caf50; margin-right: 10px;">刷新聊天记录</button>
          <button id="chat-clear-all" class="btn" style="background: #f44336;">清空全部聊天</button>
        </div>
        <table class="admin-table" id="chat-table">
          <thead><tr><th>用户名</th><th>时间</th><th>内容</th><th>操作</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="section-notice" class="admin-section">
        <h2>通知管理</h2>
        <form id="notice-form">
          <div id="notice-list"></div>
          <div style="display:flex;gap:10px;margin-top:8px;align-items:center;">
            <button type="button" id="add-notice" class="btn">新增通知</button>
            <button type="button" id="view-notice-pending" class="btn" style="background:#ff9800;">查看 pending 通知</button>
          </div>
          <div class="save-bar"><button type="submit" class="btn">保存通知</button></div>
        </form>
      </div>
    </div>
  </div>
  <script src="https://unpkg.com/@supabase/supabase-js@2" onerror="console.warn('Supabase CDN加载失败，系统将使用本地存储模式')"></script>
  <script>
    // Supabase配置
    const SUPABASE_URL = 'https://rfbjjgzmdtmvjxfbmvpm.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJmYmpqZ3ptZHRtdmp4ZmJtdnBtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyOTA1NjIsImV4cCI6MjA3Njg2NjU2Mn0.-WrayfzkBmfFWmEplWRI6RmxdZBGwU2H286QafsMQf0';
    
    // 初始化Supabase客户端（如果可用）
    let supabaseClient = null;
    try {
      if (typeof supabase !== 'undefined') {
        const { createClient } = supabase;
        supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('Supabase客户端初始化成功');
      } else {
        console.warn('Supabase库未加载，系统将使用本地存储模式');
      }
    } catch (error) {
      console.warn('Supabase初始化失败，系统将使用本地存储模式:', error);
    }

    // 验证 Supabase 客户端是否有权限可用（避免 anon key 被拒导致页面继续使用但请求 401）
    async function validateSupabaseClient() {
      if (!supabaseClient) return false;
      try {
        // 做一个小查询以检测权限（members 表通常存在）。如果返回错误或 401，则回退本地模式
        const { data, error, status } = await supabaseClient.from('members').select('id').limit(1).maybeSingle();
        if (error) {
          console.warn('Supabase 验证失败:', error, 'status:', status);
          // 如果是授权错误或其他不可恢复错误，禁用 supabaseClient
          if (status === 401 || (error && String(error).toLowerCase().includes('jwt')) ) {
            supabaseClient = null;
            console.warn('Supabase 授权失败，回退到本地存储模式');
            return false;
          }
        }
        return true;
      } catch (err) {
        console.warn('Supabase 验证异常，回退本地:', err);
        supabaseClient = null;
        return false;
      }
    }

    // 立即验证（不阻塞页面渲染）
    (async ()=>{ await validateSupabaseClient(); })();
    // 生成 UUID (v4 简易实现) 用作本地与远端匹配的 client_uuid
    function generateUUID(){
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c){
        const r = Math.random()*16|0; const v = c==='x'? r : (r&0x3|0x8); return v.toString(16);
      });
    }

    // 在 admin 成功修改数据库后写入标记，触发前端页面的 storage 监听以同步更新
    function notifyFrontendUpdate(){
      try{ localStorage.setItem('abc_last_update', new Date().toISOString()); }catch(e){ console.warn('写入 abc_last_update 失败', e); }
    }
    
    // 管理员权限验证
    async function checkAdminAuth() {
      const currentUser = localStorage.getItem('abc_current_user');
      if (currentUser !== 'admin') {
        alert('仅管理员可访问后台！');
        location.href = 'index.html';
        return false;
      }
      
      // 简化验证：只检查本地存储中的用户
      // 如果用户名为admin，则允许访问后台
      console.log('管理员身份验证通过，欢迎使用后台管理系统！');
      return true;
    }
    
    // 网络连接检测和状态显示
    function updateAdminNetworkStatus() {
      const statusDiv = document.getElementById('admin-network-status');
      const statusText = document.getElementById('admin-network-status-text');
      
      if (!navigator.onLine) {
        statusDiv.style.display = 'block';
        statusDiv.style.background = '#f44336';
        statusDiv.style.color = '#fff';
        statusText.textContent = '网络连接已断开';
        console.warn('网络连接已断开，请检查您的网络连接或VPN设置');
        return false;
      } else {
        statusDiv.style.display = 'none';
        return true;
      }
    }
    
    function checkNetworkConnection() {
      const isOnline = updateAdminNetworkStatus();
      
      if (isOnline) {
        // 使用 validateSupabaseClient 来检测 Supabase 可用性（避免无效 HEAD 导致 401 噪音）
        validateSupabaseClient().then(ok=>{
          if(!ok) console.warn('Supabase 验证失败或无权限，系统将回退到本地存储模式');
        }).catch(()=>{
          console.warn('Supabase 验证异常，系统将回退到本地存储模式');
        });
      }
      
      return isOnline;
    }
    
    // 监听网络状态变化
    window.addEventListener('online', updateAdminNetworkStatus);
    window.addEventListener('offline', updateAdminNetworkStatus);
    
    // 错误诊断和恢复系统
    function diagnoseConnectionError(error) {
      const errorMessage = error.toString().toLowerCase();
      let diagnosis = '';
      let solution = '';
      
      if (errorMessage.includes('resource_exhausted')) {
        diagnosis = '资源耗尽错误';
        solution = '服务器资源不足，请稍后重试或检查VPN设置';
      } else if (errorMessage.includes('network') || errorMessage.includes('connection')) {
        diagnosis = '网络连接错误';
        solution = '请检查网络连接或VPN设置';
      } else if (errorMessage.includes('timeout')) {
        diagnosis = '连接超时';
        solution = '网络响应缓慢，请检查网络速度或VPN设置';
      } else if (errorMessage.includes('cors')) {
        diagnosis = '跨域请求错误';
        solution = '浏览器安全策略阻止了请求';
      } else {
        diagnosis = '未知连接错误';
        solution = '请检查网络连接和VPN设置';
      }
      
      return { diagnosis, solution };
    }
    
    // 显示错误诊断信息
    function showErrorDiagnosis(error) {
      const { diagnosis, solution } = diagnoseConnectionError(error);
      const errorMsg = `连接错误诊断：\n\n错误类型：${diagnosis}\n\n建议解决方案：\n${solution}\n\n系统将自动切换到离线模式，所有功能仍可正常使用。`;
      alert(errorMsg);
      console.error('连接错误详情:', error);
    }
    
    // 全局错误捕获
    window.addEventListener('error', function(event) {
      if (event.error && event.error.toString().includes('resource_exhausted')) {
        showErrorDiagnosis(event.error);
      }
    });
    
    // 未处理的Promise拒绝捕获
    window.addEventListener('unhandledrejection', function(event) {
      if (event.reason && event.reason.toString().includes('resource_exhausted')) {
        showErrorDiagnosis(event.reason);
        event.preventDefault(); // 阻止默认的错误处理
      }
    });
    
    // 连接测试功能
    async function runConnectionTest() {
      const testBtn = document.querySelector('#connection-test-btn button');
      const originalText = testBtn.textContent;
      testBtn.textContent = '测试中...';
      testBtn.disabled = true;
      
      const results = [];
      
      // 测试Supabase服务连接（这是核心功能，最关键）
      try {
        const startTime = Date.now();
        await fetch('https://rfbjjgzmdtmvjxfbmvpm.supabase.co/rest/v1/', {
          method: 'HEAD',
          mode: 'no-cors',
          cache: 'no-cache'
        });
        const responseTime = Date.now() - startTime;
        results.push(`✓ Supabase服务连接正常 (${responseTime}ms)`);
        results.push(`✓ 基本网络连接正常（通过Supabase测试）`);
      } catch (error) {
        results.push(`✗ Supabase服务连接失败: ${error.message}`);
        results.push(`⚠ 网络连接可能存在问题，请检查网络环境`);
      }
      
      // 测试CDN资源
      try {
        const startTime = Date.now();
        await fetch('https://unpkg.com/@supabase/supabase-js@2', {
          method: 'HEAD',
          mode: 'no-cors',
          cache: 'no-cache'
        });
        const responseTime = Date.now() - startTime;
        results.push(`✓ CDN资源访问正常 (${responseTime}ms)`);
      } catch (error) {
        results.push(`✗ CDN资源访问失败: ${error.message}`);
      }
      
      // 显示测试结果
      const hasErrors = results.some(r => r.includes('✗') || r.includes('⚠'));
      const resultText = `网络连接测试结果：\n\n${results.join('\n')}\n\n说明：\n${hasErrors ? 
        '• Supabase服务正常，核心功能可用\n• 如果基本网络测试失败，可能是测试方法限制，不影响实际使用\n• 如仍有问题，请检查VPN设置或网络环境' : 
        '• 所有连接测试通过，网络状况良好'}`;
      
      alert(resultText);
      
      testBtn.textContent = originalText;
      testBtn.disabled = false;
    }
    
    // 页面加载时验证权限和网络
    checkNetworkConnection();
    checkAdminAuth();
    // 菜单切换
    document.querySelectorAll('.admin-menu li').forEach(li=>{
      li.onclick = function(){
        document.querySelectorAll('.admin-menu li').forEach(x=>x.classList.remove('active'));
        li.classList.add('active');
        document.querySelectorAll('.admin-section').forEach(x=>x.classList.remove('active'));
        document.getElementById('section-'+li.dataset.section).classList.add('active');
      };
    });
    // 会员管理 - 使用localStorage（与主页保持一致）
    function getUsers() {
      return JSON.parse(localStorage.getItem('abc_users')||'{}');
    }
    
    function setUsers(users) {
      localStorage.setItem('abc_users', JSON.stringify(users));
    }
    
    async function fetchMembers() {
      if (supabaseClient) {
        const { data, error } = await supabaseClient.from('members').select('username').order('username');
        if (!error && data) return data.map(r=>r.username).filter(u=>u!=='admin');
        console.warn('从Supabase获取会员失败，回退本地:', error && error.message);
      }
      const users = getUsers();
      return Object.keys(users).filter(username => username !== 'admin');
    }
    
    async function renderMembers() {
      const memberUsers = await fetchMembers();
      const tbody = document.querySelector('#member-table tbody');
      tbody.innerHTML = '';
      if (!memberUsers || memberUsers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="2" style="text-align:center;color:#888;">暂无会员数据</td></tr>';
        return;
      }
      memberUsers.forEach((username, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${username}</td>
          <td>
            <button class='btn' onclick='deleteMember(${index}, "${username}")'>删除</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }
    
    // 删除会员
    async function deleteMember(memberIndex, username) {
      if (!confirm(`确定要删除会员 ${username} 吗？`)) {
        return;
      }
      if (supabaseClient) {
        const { error } = await supabaseClient.from('members').delete().eq('username', username);
        if (error) {
          console.warn('Supabase删除会员失败，回退本地:', error.message);
        } else {
          alert('会员删除成功！');
          renderMembers();
          return;
        }
      }
      const users = getUsers();
      if (users[username] && username !== 'admin') {
        delete users[username];
        setUsers(users);
        alert('会员删除成功！');
        renderMembers();
      } else {
        alert('删除失败，请重试');
      }
    }
    
    // 页面加载时渲染会员列表
    renderMembers();
    
    // 添加实时刷新功能
    function refreshAllData() {
      renderMembers();
      renderChatTable();
    }
    
    // 监听localStorage变化，自动刷新数据
    window.addEventListener('storage', function(e) {
      if (e.key === 'abc_users') {
        renderMembers();
      } else if (e.key === 'abc_chat_msgs') {
        renderChatTable();
      }
    });
    
    // 每30秒自动刷新一次数据
    setInterval(refreshAllData, 30000);
    
    // 手动刷新按钮事件
    document.getElementById('refresh-members').onclick = function() {
      renderMembers();
      alert('会员列表已刷新！');
    };
    
    document.getElementById('refresh-chat').onclick = function() {
      renderChatTable();
      alert('聊天记录已刷新！');
    };
    // 广告管理 - 使用localStorage（与主页保持一致）
    function getAdData() {
      const raw = JSON.parse(localStorage.getItem('abc_ads')||'{"banner":[],"footer":[]}');
      const normalizeArr = (arr)=> (arr||[]).map(item=>{
        if(typeof item === 'string') { return { text: item, imgs: [] }; }
        if(item && typeof item === 'object') {
          return { text: (item.text||''), imgs: Array.isArray(item.imgs)? item.imgs : [] };
        }
        return { text: '', imgs: [] };
      });
      return { banner: normalizeArr(raw.banner), footer: normalizeArr(raw.footer) };
    }
    
    function setAdData(data) {
  localStorage.setItem('abc_ads', JSON.stringify(data));
  try{ if(localStorage.getItem('abc_local_only') === null) localStorage.setItem('abc_local_only','1'); }catch(e){}
  try{ localStorage.setItem('abc_last_update', new Date().toISOString()); }catch(e){}
    }
    function createAdItem(ad, type, idx) {
      // type: 'banner' or 'footer'
  const dbAttr = ad && ad.db_id ? `data-db-id='${ad.db_id}'` : '';
  return `<div class="ad-item" ${dbAttr} style="border:1px solid #e0eafc;padding:10px 8px;margin-bottom:10px;border-radius:8px;position:relative;">
        <textarea placeholder="广告文字" style="width:100%;min-height:40px;border-radius:6px;border:1px solid #ccc;padding:6px 8px;font-size:1em;resize:vertical;">${ad.text||''}</textarea>
        <div class="ad-imgs" style="display:flex;gap:8px;margin:8px 0 0 0;flex-wrap:wrap;">
          ${(ad.imgs||[]).map((img,i)=>`<div style='position:relative;display:inline-block;'><img src='${img}' style='width:60px;height:60px;object-fit:cover;border-radius:6px;border:1px solid #ccc;'><span data-type='${type}' data-adidx='${idx}' data-imgidx='${i}' class='del-img-btn' style='position:absolute;top:-8px;right:-8px;background:#f44336;color:#fff;border-radius:50%;width:18px;height:18px;display:flex;align-items:center;justify-content:center;font-size:0.9em;cursor:pointer;'>×</span></div>`).join('')}
          ${(ad.imgs||[]).length<3?`<label style='width:60px;height:60px;display:inline-flex;align-items:center;justify-content:center;border:1px dashed #2d8cf0;border-radius:6px;cursor:pointer;background:#f7faff;'><span style='font-size:2em;color:#2d8cf0;'>+</span><input type='file' accept='image/*' style='display:none;'></label>`:''}
        </div>
  <button type="button" class="btn del-ad-btn" data-type="${type}" data-idx="${idx}" style="position:absolute;top:8px;right:8px;background:#f44336;">删除</button>
      </div>`;
    }
    async function renderAdForm() {
      try {
        const adData = await getAdData();
        const bannerList = document.getElementById('ad-banner-list');
        const footerList = document.getElementById('ad-footer-list');
        bannerList.innerHTML = (adData.banner||[]).map((ad,i)=>createAdItem(ad,'banner',i)).join('');
        footerList.innerHTML = (adData.footer||[]).map((ad,i)=>createAdItem(ad,'footer',i)).join('');
      } catch (err) {
        console.error('渲染广告表单失败:', err);
      }
    }
    renderAdForm();
    // 事件委托：图片上传、删除、广告删除
    document.getElementById('ad-banner-list').onclick = document.getElementById('ad-footer-list').onclick = function(e) {
      const target = e.target;
      // 删除图片
      if(target.classList.contains('del-img-btn')) {
        const type = target.dataset.type, adidx = +target.dataset.adidx, imgidx = +target.dataset.imgidx;
        const adData = getAdData();
        adData[type][adidx].imgs.splice(imgidx,1);
        setAdData(adData);
        renderAdForm();
        return;
      }
      // 删除广告
      if(target.classList.contains('del-ad-btn')) {
        const type = target.dataset.type, idx = +target.dataset.idx;
        const adData = getAdData();
        // 如果该广告有 db_id，尝试删除数据库记录
        const parent = target.closest('.ad-item');
        const dbId = parent ? parent.getAttribute('data-db-id') : null;
        if(dbId && supabaseClient){
          (async ()=>{
            try{
              const { error } = await supabaseClient.from('advertisements').delete().eq('id', dbId);
              if(error){
                // 写入 pending delete
                try{ const pending = JSON.parse(localStorage.getItem('abc_ads_pending')||'[]'); pending.push({ op:'delete', table:'advertisements', id: dbId, created_at: new Date().toISOString() }); localStorage.setItem('abc_ads_pending', JSON.stringify(pending)); }catch(e){console.error('写入 ads pending 删除失败', e);} 
                console.warn('数据库删除广告失败，已加入 pending', error);
              } else {
                // 删除成功，通知前端刷新
                notifyFrontendUpdate();
              }
            }catch(err){
              try{ const pending = JSON.parse(localStorage.getItem('abc_ads_pending')||'[]'); pending.push({ op:'delete', table:'advertisements', id: dbId, created_at: new Date().toISOString() }); localStorage.setItem('abc_ads_pending', JSON.stringify(pending)); }catch(e){console.error('写入 ads pending 删除失败', e);} 
              console.error('删除广告异常，已加入 pending', err);
            }
          })();
        }
        adData[type].splice(idx,1);
        setAdData(adData);
        renderAdForm();
        return;
      }
    };
    // 图片上传
    document.getElementById('ad-banner-list').addEventListener('change', handleImgUpload, true);
    document.getElementById('ad-footer-list').addEventListener('change', handleImgUpload, true);
    function handleImgUpload(e) {
      const input = e.target;
      if(input.type==='file' && input.files && input.files[0]) {
        const parent = input.closest('.ad-item');
        const type = parent.parentElement.id==='ad-banner-list'?'banner':'footer';
        const idx = Array.from(parent.parentElement.children).indexOf(parent);
        const file = input.files[0];
  if(!file.type.match(/^image\//)) { alert('仅支持图片文件（jpg/png/gif/webp 等）'); return; }
        if(file.size > 2*1024*1024) { alert('图片不能超过2MB'); return; }
        const reader = new FileReader();
        reader.onload = function(ev){
          const adData = getAdData();
          adData[type][idx].imgs = adData[type][idx].imgs||[];
          if(adData[type][idx].imgs.length>=3) return;
          adData[type][idx].imgs.push(ev.target.result);
          setAdData(adData);
          renderAdForm();
        };
        reader.readAsDataURL(file);
      }
    }
    // 文字输入
    document.getElementById('ad-banner-list').addEventListener('input', handleTextInput, true);
    document.getElementById('ad-footer-list').addEventListener('input', handleTextInput, true);
    function handleTextInput(e) {
      if(e.target.tagName==='TEXTAREA') {
        const parent = e.target.closest('.ad-item');
        const type = parent.parentElement.id==='ad-banner-list'?'banner':'footer';
        const idx = Array.from(parent.parentElement.children).indexOf(parent);
        const adData = getAdData();
        adData[type][idx].text = e.target.value;
        setAdData(adData);
      }
    }
    // 新增广告
    document.getElementById('add-banner-ad').onclick = function() {
      const adData = getAdData();
  adData.banner.push({text:'',imgs:[], created_at: new Date().toISOString(), client_uuid: generateUUID()});
      setAdData(adData);
      renderAdForm();
    };
    document.getElementById('add-footer-ad').onclick = function() {
      const adData = getAdData();
  adData.footer.push({text:'',imgs:[], created_at: new Date().toISOString(), client_uuid: generateUUID()});
      setAdData(adData);
      renderAdForm();
    };
    // 保存广告（Supabase远程和本地）
    document.getElementById('ad-form').onsubmit = async function(e){
      e.preventDefault();
      const data = getAdData();
      const clean = (arr)=> (arr||[]).filter(it=>{
        const hasText = (it && typeof it.text==='string' && it.text.trim().length>0);
        const hasImgs = (it && it.imgs && it.imgs.length>0);
        return hasText || hasImgs;
      });
      const newData = { banner: clean(data.banner), footer: clean(data.footer) };
      setAdData(newData);

      // 如果启用了仅本地同步，跳过远端写入并通知前端刷新
      if (localStorage.getItem('abc_local_only') === '1') {
        try{ localStorage.setItem('abc_last_update', new Date().toISOString()); }catch(e){}
        alert('广告已保存（仅本地模式）。已通知前端刷新。');
        return;
      }

      // ------- 写入Supabase广告表，失败时输出详细错误 -------
      if (supabaseClient) {
        let succ = 0, fail = 0, failMsg = '';
        // 顶部广告
        for(const ad of newData.banner){
          const payload = {
            ad_type: 'banner',
            type: 'banner',
            content: ad.text||'',
            imgs: Array.isArray(ad.imgs) ? JSON.stringify(ad.imgs) : JSON.stringify([]),
            client_uuid: ad.client_uuid || null,
            admin_id: 1,
            created_at: new Date().toISOString()
          };
          try {
            if(ad.db_id){
              // update existing
              const { error } = await supabaseClient.from('advertisements').update(payload).eq('id', ad.db_id);
              if(error){ fail++; failMsg = error.message||String(error); console.error('广告更新失败(banner):', { payload, error });
                try{ const pending = JSON.parse(localStorage.getItem('abc_ads_pending')||'[]'); pending.push({ op:'update', table:'advertisements', id:ad.db_id, payload, created_at:new Date().toISOString() }); localStorage.setItem('abc_ads_pending', JSON.stringify(pending)); }catch(e){console.error('写入 ads pending 失败', e);} }
              else succ++;
            } else {
              const { data:inserted, error } = await supabaseClient.from('advertisements').insert(payload).select('id, client_uuid').maybeSingle();
              if(error){ fail++; failMsg = error.message||String(error); console.error('广告写入失败(banner):', { payload, error });
                try{ const pending = JSON.parse(localStorage.getItem('abc_ads_pending')||'[]'); pending.push({ op:'insert', table:'advertisements', payload, client_uuid: payload.client_uuid||null, created_at:new Date().toISOString() }); localStorage.setItem('abc_ads_pending', JSON.stringify(pending)); }catch(e){console.error('写入 ads pending 失败', e);} }
              else { succ++; if(inserted && inserted.id){ /* 写回 localStorage，使用 created_at 匹配注入 db_id */
                  const current = getAdData();
                  const arr = current.banner || [];
                  // 优先使用 client_uuid 来精确匹配
                  for(let i=0;i<arr.length;i++){
                    if(!arr[i].db_id && payload.client_uuid && arr[i].client_uuid && arr[i].client_uuid === payload.client_uuid){ arr[i].db_id = inserted.id; break; }
                  }
                  // 回退到 created_at 匹配
                  for(let i=0;i<arr.length;i++){ if(!arr[i].db_id && arr[i].created_at && arr[i].created_at === payload.created_at){ arr[i].db_id = inserted.id; break; } }
                  setAdData(current);
                }
              }
            }
          } catch (err) {
            fail++; failMsg = String(err); console.error('广告写入异常(banner):', { payload, err });
            try{ const pending = JSON.parse(localStorage.getItem('abc_ads_pending')||'[]'); pending.push({ op: ad.db_id? 'update':'insert', table:'advertisements', id: ad.db_id||null, payload, created_at:new Date().toISOString() }); localStorage.setItem('abc_ads_pending', JSON.stringify(pending)); }catch(e){console.error('写入 ads pending 失败', e);} 
          }
        }
        // 底部广告
        for(const ad of newData.footer){
          const payload = {
            ad_type: 'footer',
            type: 'footer',
            content: ad.text||'',
            imgs: Array.isArray(ad.imgs) ? JSON.stringify(ad.imgs) : JSON.stringify([]),
            client_uuid: ad.client_uuid || null,
            admin_id: 1,
            created_at: new Date().toISOString()
          };
          try {
            if(ad.db_id){
              const { error } = await supabaseClient.from('advertisements').update(payload).eq('id', ad.db_id);
              if(error){ fail++; failMsg = error.message||String(error); console.error('广告更新失败(footer):', { payload, error }); try{ const pending = JSON.parse(localStorage.getItem('abc_ads_pending')||'[]'); pending.push({ op:'update', table:'advertisements', id:ad.db_id, payload, created_at:new Date().toISOString() }); localStorage.setItem('abc_ads_pending', JSON.stringify(pending)); }catch(e){console.error('写入 ads pending 失败', e);} }
              else succ++;
            } else {
              const { data:inserted, error } = await supabaseClient.from('advertisements').insert(payload).select('id, client_uuid').maybeSingle();
              if(error){ fail++; failMsg = error.message||String(error); console.error('广告写入失败(footer):', { payload, error }); try{ const pending = JSON.parse(localStorage.getItem('abc_ads_pending')||'[]'); pending.push({ op:'insert', table:'advertisements', payload, created_at:new Date().toISOString() }); localStorage.setItem('abc_ads_pending', JSON.stringify(pending)); }catch(e){console.error('写入 ads pending 失败', e);} }
              else { succ++; if(inserted && inserted.id){ const current = getAdData(); const arr = current.footer || []; for(let i=0;i<arr.length;i++){ if(!arr[i].db_id && payload.client_uuid && arr[i].client_uuid && arr[i].client_uuid === payload.client_uuid){ arr[i].db_id = inserted.id; break; } } for(let i=0;i<arr.length;i++){ if(!arr[i].db_id && arr[i].created_at && arr[i].created_at === payload.created_at){ arr[i].db_id = inserted.id; break; } } setAdData(current); } }
            }
          } catch (err) {
            // 遇到异常（如 401/网络等）时，将 payload 暂存到本地 pending 队列，便于后续重试与审核
            fail++; failMsg = String(err); console.error('广告写入异常(footer):', { payload, err });
            try {
              const pending = JSON.parse(localStorage.getItem('abc_ads_pending')||'[]');
              pending.push({ op: ad.db_id? 'update':'insert', table:'advertisements', id: ad.db_id||null, payload, created_at:new Date().toISOString() });
              localStorage.setItem('abc_ads_pending', JSON.stringify(pending));
              console.warn('已将失败的广告写入 pending 队列（abc_ads_pending）');
            } catch(e) { console.error('写入 pending 队列失败', e); }
          }
        }
        if (succ>0) {
          alert(`有 ${succ} 条广告已发布到数据库。会员可见！` + (fail>0?`\n失败${fail}条: ${failMsg}`:''));
        } else {
          alert('未能成功存储到数据库（广告）。\n错误信息: ' + (failMsg||'未知错误') + '\n\n请检查: 表字段是否为(type, content, imgs, admin_id, created_at)，RLS策略是否允许 anon INSERT');
        }
        return;
      }
      alert('广告已保存！（仅本地，未同步数据库）');
    };
    // 退出后台
    document.getElementById('admin-logout').onclick = function(){
      location.href='index.html';
    };
    // 聊天管理功能 - 使用localStorage（与主页保持一致）
    function getChatMsgs() {
      return JSON.parse(localStorage.getItem('abc_chat_msgs')||'[]');
    }
    
    function setChatMsgs(msgs) {
      localStorage.setItem('abc_chat_msgs', JSON.stringify(msgs));
    }
    
    function deleteChatMessage(messageId) {
      const msgs = getChatMsgs();
      const filteredMsgs = msgs.filter((msg, index) => index !== messageId);
      setChatMsgs(filteredMsgs);
    }
    
    function renderChatTable() {
      const msgs = getChatMsgs();
      const tbody = document.querySelector('#chat-table tbody');
      tbody.innerHTML = '';
      
      if (!msgs || msgs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#888;">暂无聊天记录</td></tr>';
        return;
      }
      
      msgs.forEach((msg, index) => {
        let content = '';
        if (msg.text) content += `<span style='word-break:break-all;'>${msg.text}</span>`;
        if (msg.img) content += `<br><img src='${msg.img}' style='max-width:90px;max-height:60px;border-radius:6px;margin-top:4px;'>`;
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${msg.user}</td>
          <td>${msg.time}</td>
          <td style='text-align:left;'>${content}</td>
          <td><button class='btn' onclick='deleteChatMsg(${index})'>删除</button></td>
        `;
        tbody.appendChild(tr);
      });
    }
    
    function deleteChatMsg(messageId) {
      if (!confirm('确定要删除这条消息吗？')) {
        return;
      }
      
      deleteChatMessage(messageId);
      alert('消息删除成功！');
      renderChatTable();
    }
    // 聊天管理区切换时刷新
    const chatMenuLi = document.querySelector('li[data-section="chat"]');
    chatMenuLi.addEventListener('click', renderChatTable);
    // 页面初始如果就在聊天管理区，也要渲染一次
    if(chatMenuLi.classList.contains('active')) renderChatTable();
    // 清空全部聊天
    const chatClearBtn = document.getElementById('chat-clear-all');
    chatClearBtn.onclick = function(){
      if(confirm('确定要清空全部聊天记录吗？')){
        setChatMsgs([]);
        renderChatTable();
        alert('聊天记录已清空！');
      }
    };
    // 监听聊天内容变化，自动刷新
    window.addEventListener('storage', function(e){
      if(e.key==='abc_chat_msgs' && document.getElementById('section-chat').classList.contains('active')) {
        renderChatTable();
      }
    });

    // 通知管理 - 使用localStorage（与主页保持一致）
    function getNotices() {
      return JSON.parse(localStorage.getItem('abc_notices')||'[]');
    }
    
    function setNotices(data) {
  localStorage.setItem('abc_notices', JSON.stringify(data));
  try{ if(localStorage.getItem('abc_local_only') === null) localStorage.setItem('abc_local_only','1'); }catch(e){}
  try{ localStorage.setItem('abc_last_update', new Date().toISOString()); }catch(e){}
    }
    function createNoticeItem(notice, idx) {
  const dbAttr = notice && notice.db_id ? `data-db-id='${notice.db_id}'` : '';
  return `<div class="notice-item" ${dbAttr} style="border:1px solid #e0eafc;padding:10px 8px;margin-bottom:10px;border-radius:8px;position:relative;">
        <textarea placeholder="通知内容" style="width:100%;min-height:40px;border-radius:6px;border:1px solid #ccc;padding:6px 8px;font-size:1em;resize:vertical;">${notice.text||''}</textarea>
        <div style="margin:8px 0 0 0;display:flex;align-items:center;gap:8px;">
          ${notice.img?`<div style='position:relative;display:inline-block;'><img src='${notice.img}' style='width:60px;height:60px;object-fit:cover;border-radius:6px;border:1px solid #ccc;'><span data-idx='${idx}' class='del-notice-img-btn' style='position:absolute;top:-8px;right:-8px;background:#f44336;color:#fff;border-radius:50%;width:18px;height:18px;display:flex;align-items:center;justify-content:center;font-size:0.9em;cursor:pointer;'>×</span></div>`:''}
          ${!notice.img?`<label style='width:60px;height:60px;display:inline-flex;align-items:center;justify-content:center;border:1px dashed #2d8cf0;border-radius:6px;cursor:pointer;background:#f7faff;position:relative;'><span style='font-size:2em;color:#2d8cf0;'>+</span><input type='file' accept='image/*' style='display:block;opacity:0;position:absolute;left:0;top:0;width:100%;height:100%;cursor:pointer;'></label>`:''}
        </div>
        <div style="font-size:0.9em;color:#888;margin-top:4px;">${notice.time||''}</div>
        <button type="button" class="btn del-notice-btn" data-idx="${idx}" style="position:absolute;top:8px;right:8px;background:#f44336;">删除</button>
      </div>`;
    }
    function renderNoticeForm() {
      const notices = getNotices();
      const list = document.getElementById('notice-list');
      list.innerHTML = notices.map((n,i)=>createNoticeItem(n,i)).join('');
    }
    // 事件委托：图片上传、删除、通知删除
    document.getElementById('notice-list').onclick = function(e) {
      const target = e.target;
      // 删除图片
      if(target.classList.contains('del-notice-img-btn')) {
        const idx = +target.dataset.idx;
        const notices = getNotices();
        notices[idx].img = '';
        setNotices(notices);
        renderNoticeForm();
        return;
      }
      // 删除通知
      if(target.classList.contains('del-notice-btn')) {
        const idx = +target.dataset.idx;
        const parent = target.closest('.notice-item');
        const dbId = parent ? parent.getAttribute('data-db-id') : null;
        if(dbId && supabaseClient){
          (async ()=>{
            try{
              const { error } = await supabaseClient.from('notices').delete().eq('id', dbId);
              if(error){
                try{ const pend = JSON.parse(localStorage.getItem('abc_notices_pending')||'[]'); pend.push({ op:'delete', table:'notices', id:dbId, created_at:new Date().toISOString() }); localStorage.setItem('abc_notices_pending', JSON.stringify(pend)); }catch(e){console.error('写入 notices pending 删除失败', e);} 
                console.warn('数据库删除通知失败，已加入 pending', error);
              } else {
                // 删除成功，通知前端刷新
                notifyFrontendUpdate();
              }
            }catch(err){ try{ const pend = JSON.parse(localStorage.getItem('abc_notices_pending')||'[]'); pend.push({ op:'delete', table:'notices', id:dbId, created_at:new Date().toISOString() }); localStorage.setItem('abc_notices_pending', JSON.stringify(pend)); }catch(e){console.error('写入 notices pending 删除失败', e);} console.error('删除通知异常，已加入 pending', err); }
          })();
        }
        const notices = getNotices();
        notices.splice(idx,1);
        setNotices(notices);
        renderNoticeForm();
        return;
      }
    };
    // 图片上传
    document.getElementById('notice-list').addEventListener('change', function(e) {
      const input = e.target;
      if(input.type==='file' && input.files && input.files[0]) {
        const parent = input.closest('.notice-item');
        const items = Array.from(parent.parentElement.querySelectorAll('.notice-item'));
        const idx = items.indexOf(parent);
        const file = input.files[0];
  if(!file.type.match(/^image\//)) { alert('仅支持图片文件（jpg/png/gif/webp 等）'); return; }
        if(file.size > 2*1024*1024) { alert('图片不能超过2MB'); return; }
        const reader = new FileReader();
        reader.onload = function(ev){
          const notices = getNotices();
          notices[idx].img = ev.target.result;
          setNotices(notices);
          renderNoticeForm();
        };
        reader.readAsDataURL(file);
      }
    }, true);
    // 文字输入
    document.getElementById('notice-list').addEventListener('input', function(e) {
      if(e.target.tagName==='TEXTAREA') {
        const parent = e.target.closest('.notice-item');
        const items = Array.from(parent.parentElement.querySelectorAll('.notice-item'));
        const idx = items.indexOf(parent);
        const notices = getNotices();
        notices[idx].text = e.target.value;
        setNotices(notices);
      }
    }, true);
    // 新增通知
    document.getElementById('add-notice').onclick = function() {
      const notices = getNotices();
      const now = new Date();
      const time = now.getFullYear()+"-"+(now.getMonth()+1)+"-"+now.getDate()+" "+now.getHours()+":"+String(now.getMinutes()).padStart(2,'0');
  notices.unshift({text:'',img:'',time, created_at: new Date().toISOString(), client_uuid: generateUUID()});
      setNotices(notices);
      renderNoticeForm();
    };
    // 保存通知（支持 update/insert 到 Supabase，并在失败时写入 pending）
    document.getElementById('notice-form').onsubmit = async function(e){
      e.preventDefault();
      const notices = getNotices();
      // 先本地保存（local-first），保证管理员立即看到
      setNotices(notices);

      // 如果启用了仅本地同步，跳过远端写入并通知前端刷新
      if (localStorage.getItem('abc_local_only') === '1') {
        try{ localStorage.setItem('abc_last_update', new Date().toISOString()); }catch(e){}
        alert('通知已保存（仅本地模式）。已通知前端刷新。');
        return;
      }

      if (supabaseClient) {
        let succ = 0, fail = 0, failMsg = '';
        for (const n of notices) {
          if (!n.text || !n.text.trim()) continue;
          const payload = {
            content: n.text,
            img: n.img || null,
            time: n.time || null,
            client_uuid: n.client_uuid || null,
            admin_id: 1,
            created_at: new Date().toISOString()
          };
          try {
            if(n.db_id){
              // update existing notice
              const { error } = await supabaseClient.from('notices').update(payload).eq('id', n.db_id);
              if(error){
                fail++; failMsg = error.message || String(error);
                console.error('通知更新失败:', { payload, error });
                try{ const pending = JSON.parse(localStorage.getItem('abc_notices_pending')||'[]'); pending.push({ op:'update', table:'notices', id:n.db_id, payload, created_at:new Date().toISOString() }); localStorage.setItem('abc_notices_pending', JSON.stringify(pending)); }catch(e){ console.error('写入 notices pending 失败', e); }
              } else {
                succ++;
                // 成功更新，通知前端刷新
                notifyFrontendUpdate();
              }
            } else {
              const { data: inserted, error } = await supabaseClient.from('notices').insert(payload).select('id, client_uuid').maybeSingle();
              if(error){
                fail++; failMsg = error.message || String(error);
                console.error('通知写入失败:', { payload, error });
                try{ const pending = JSON.parse(localStorage.getItem('abc_notices_pending')||'[]'); pending.push({ op:'insert', table:'notices', payload, created_at:new Date().toISOString() }); localStorage.setItem('abc_notices_pending', JSON.stringify(pending)); }catch(e){ console.error('写入 notices pending 失败', e); }
              } else {
                succ++;
                // 插入成功，通知前端刷新
                notifyFrontendUpdate();
                if(inserted && inserted.id){
                  // 写回 localStorage: 尝试在本地匹配刚插入的通知并记录 db_id
                  try{
                    const current = getNotices();
                    // 优先使用 client_uuid 精确匹配
                    for(let i=0;i<current.length;i++){
                      if(!current[i].db_id && n.client_uuid && current[i].client_uuid && current[i].client_uuid === n.client_uuid){ current[i].db_id = inserted.id; break; }
                    }
                    // 回退到文本+图片匹配
                    for(let i=0;i<current.length;i++){
                      if(!current[i].db_id && current[i].text===n.text && (current[i].img||'')===(n.img||'')){
                        current[i].db_id = inserted.id; break;
                      }
                    }
                    setNotices(current);
                  }catch(e){ console.warn('写回 db_id 到 localStorage 失败', e); }
                }
              }
            }
          } catch (err) {
            fail++; failMsg = String(err); console.error('通知写入异常:', { payload, err });
            try{ const pending = JSON.parse(localStorage.getItem('abc_notices_pending')||'[]'); pending.push({ op: n.db_id? 'update':'insert', table:'notices', id: n.db_id||null, payload, created_at:new Date().toISOString() }); localStorage.setItem('abc_notices_pending', JSON.stringify(pending)); }catch(e){ console.error('写入通知 pending 失败', e); }
          }
        }
        if (succ>0) alert(`有 ${succ} 条通知已发布到数据库。会员可见！` + (fail>0?`\n失败${fail}条: ${failMsg}`:''));
        else alert('未能成功存储到数据库（通知）。请检查网络/权限/表结构，数据已本地保存。');
        return;
      }
      // 离线回退：仅本地保存（已保存）
      alert('通知已保存到本地（离线模式）。联网后将尝试同步数据库，失败会写入 pending 队列。');
    };
    const noticeMenuLi = document.querySelector('li[data-section="notice"]');
    noticeMenuLi.addEventListener('click', renderNoticeForm);

    // Pending 通知管理：UI modal + 操作（查看/重试/删除）
    // 创建 modal（如果尚未存在）
    if(!document.getElementById('notice-pending-modal')){
      const pmodal = document.createElement('div');
      pmodal.id = 'notice-pending-modal';
      pmodal.style = 'display:none;position:fixed;z-index:20010;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.45);justify-content:center;align-items:center;';
      pmodal.innerHTML = `
        <div style='background:#fff;border-radius:12px;padding:18px;max-width:820px;width:90%;max-height:80vh;overflow:auto;position:relative;'>
          <div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;'>
            <h3 style='margin:0;color:#2d8cf0;'>Pending 通知队列</h3>
            <div style='display:flex;gap:8px;align-items:center;'>
              <button id='retry-all-notices' class='btn' style='background:#4caf50;'>全部重试</button>
              <button id='clear-all-notices' class='btn' style='background:#f44336;'>清空所有</button>
              <button id='close-pending-modal' class='btn' style='background:#ccc;color:#222;'>关闭</button>
            </div>
          </div>
          <div id='notice-pending-list' style='display:flex;flex-direction:column;gap:8px;'></div>
        </div>`;
      document.body.appendChild(pmodal);
      document.getElementById('close-pending-modal').onclick = ()=>{ pmodal.style.display='none'; };
      pmodal.onclick = function(e){ if(e.target===pmodal) pmodal.style.display='none'; };
    }

    document.getElementById('view-notice-pending').onclick = function(){
      renderPendingNotices();
      document.getElementById('notice-pending-modal').style.display = 'flex';
    };

    function getNoticePending() {
      return JSON.parse(localStorage.getItem('abc_notices_pending')||'[]');
    }
    function setNoticePending(list) {
      localStorage.setItem('abc_notices_pending', JSON.stringify(list));
    }

    function renderPendingNotices(){
      const listEl = document.getElementById('notice-pending-list');
      const items = getNoticePending();
      if(!items || !items.length){ listEl.innerHTML = "<div style='color:#888;text-align:center;padding:20px 0;'>暂无 pending 通知</div>"; return; }
      listEl.innerHTML = items.map((p,idx)=>{
        return `<div style='border:1px solid #e0eafc;padding:12px;border-radius:8px;display:flex;gap:12px;align-items:flex-start;'>
          <div style='flex:1;text-align:left;'>
            <div style='font-weight:bold;color:#2d8cf0;margin-bottom:6px;'>${p.content||''}</div>
            <div style='color:#666;font-size:0.92em;margin-bottom:6px;'>${p.time||''} <span style='color:#999;margin-left:8px;font-size:0.85em;'>创建: ${p.created_at||''}</span></div>
            ${p.img?`<img src='${p.img}' style='max-width:180px;max-height:110px;border-radius:8px;margin-top:6px;'>`:''}
          </div>
          <div style='display:flex;flex-direction:column;gap:8px;align-items:flex-end;'>
            <button class='btn retry-notice-btn' data-idx='${idx}' style='background:#4caf50;'>重试</button>
            <button class='btn del-pending-notice-btn' data-idx='${idx}' style='background:#f44336;'>删除</button>
          </div>
        </div>`;
      }).join('');

      // 绑定按钮事件
      Array.from(document.querySelectorAll('.retry-notice-btn')).forEach(btn=>{
        btn.onclick = async function(){
          const idx = +this.dataset.idx;
          await retryPendingNotice(idx);
          renderPendingNotices();
        };
      });
      Array.from(document.querySelectorAll('.del-pending-notice-btn')).forEach(btn=>{
        btn.onclick = function(){
          const idx = +this.dataset.idx;
          const items = getNoticePending(); items.splice(idx,1); setNoticePending(items); renderPendingNotices();
        };
      });
    }

    async function retryPendingNotice(idx){
      const items = getNoticePending();
      if(!items || !items[idx]) return;
      const payload = items[idx];
      if(!supabaseClient){ alert('当前未连接到 Supabase，无法重试，请检查网络或稍后再试'); return; }
      try {
        const { error } = await supabaseClient.from('notices').insert(payload);
        if(error){ alert('重试失败: '+(error.message||String(error))); console.error('重试失败', error); return; }
        // 成功则从 pending 中移除
        items.splice(idx,1); setNoticePending(items);
  // 重试成功，通知前端更新
  notifyFrontendUpdate();
        alert('重试成功，通知已发布至数据库');
      } catch(err){ console.error('重试异常', err); alert('重试异常：' + String(err)); }
    }

    document.getElementById('retry-all-notices').onclick = async function(){
      const items = getNoticePending();
      if(!items || !items.length) { alert('暂无 pending 条目'); return; }
      if(!supabaseClient){ alert('未连接 Supabase，无法重试'); return; }
      let succ = 0, fail = 0;
      for(let i=items.length-1;i>=0;i--){ // 反向遍历以便安全删除
        try{
          const { error } = await supabaseClient.from('notices').insert(items[i]);
          if(error) { fail++; console.error('重试条目失败', error); }
          else { succ++; items.splice(i,1); }
        }catch(err){ fail++; console.error('重试条目异常', err); }
      }
      setNoticePending(items);
      renderPendingNotices();
      alert(`全部重试完成：成功 ${succ}，失败 ${fail}`);
    };

    document.getElementById('clear-all-notices').onclick = function(){
      if(confirm('确定要清空所有 pending 通知吗？此操作不可撤销')){
        setNoticePending([]); renderPendingNotices(); alert('已清空 pending 列表');
      }
    };

    // ---------- Pending 自动重试（广告与通知） ----------
    function getAdsPending(){ return JSON.parse(localStorage.getItem('abc_ads_pending')||'[]'); }
    function setAdsPending(list){ localStorage.setItem('abc_ads_pending', JSON.stringify(list)); }

    let _processingPending = false;
    async function processPendingQueues(){
      if(_processingPending) return;
      _processingPending = true;
      try{
        if(!supabaseClient){ return; }
        // 处理广告 pending
        let adsPending = getAdsPending();
        let adsChanged = false;
        for(let i=adsPending.length-1;i>=0;i--){
          const item = adsPending[i];
          try{
            if(item.op === 'delete' && item.table === 'advertisements' && item.id){
              const { error } = await supabaseClient.from('advertisements').delete().eq('id', item.id);
              if(!error){ adsPending.splice(i,1); adsChanged = true; }
            } else if(item.op === 'insert' && item.table === 'advertisements' && item.payload){
              const { data, error } = await supabaseClient.from('advertisements').insert(item.payload).select('id, client_uuid').maybeSingle();
              if(!error && data && data.id){
                // 写回 localStorage 的 db_id
                try{ const current = getAdData(); ['banner','footer'].forEach(section=>{ (current[section]||[]).forEach(a=>{ if(!a.db_id && item.client_uuid && a.client_uuid && a.client_uuid===item.client_uuid){ a.db_id = data.id; } }); }); setAdData(current); }catch(e){console.warn('写回 ads db_id 失败', e);}                
                adsPending.splice(i,1);
                adsChanged = true;
              }
            } else if(item.op === 'update' && item.table === 'advertisements' && item.id && item.payload){
              const { error } = await supabaseClient.from('advertisements').update(item.payload).eq('id', item.id);
              if(!error){ adsPending.splice(i,1); adsChanged = true; }
            }
          }catch(err){ console.warn('处理 ads pending 条目失败，稍后重试', err); }
        }
        setAdsPending(adsPending);

        // 处理通知 pending
        let noticesPending = JSON.parse(localStorage.getItem('abc_notices_pending')||'[]');
        let noticesChanged = false;
        for(let i=noticesPending.length-1;i>=0;i--){
          const it = noticesPending[i];
          try{
            if(it.op === 'delete' && it.table === 'notices' && it.id){
              const { error } = await supabaseClient.from('notices').delete().eq('id', it.id);
              if(!error){ noticesPending.splice(i,1); noticesChanged = true; }
            } else if(it.op === 'insert' && it.table === 'notices' && it.payload){
              const { data, error } = await supabaseClient.from('notices').insert(it.payload).select('id, client_uuid').maybeSingle();
              if(!error && data && data.id){
                try{ const current = getNotices(); for(let j=0;j<current.length;j++){ if(!current[j].db_id && it.client_uuid && current[j].client_uuid && current[j].client_uuid===it.client_uuid){ current[j].db_id = data.id; break; } } setNotices(current); }catch(e){console.warn('写回 notices db_id 失败', e);}                
                noticesPending.splice(i,1);
                noticesChanged = true;
              }
            } else if(it.op === 'update' && it.table === 'notices' && it.id && it.payload){
              const { error } = await supabaseClient.from('notices').update(it.payload).eq('id', it.id);
              if(!error){ noticesPending.splice(i,1); noticesChanged = true; }
            }
          }catch(err){ console.warn('处理 notices pending 条目失败，稍后重试', err); }
        }
        setNoticePending(noticesPending);

        // 如果有任何改动，通知前端刷新
        if(adsChanged || noticesChanged){ notifyFrontendUpdate(); }
      }finally{ _processingPending = false; }
    }

    // 页面加载时尝试处理一次 pending，并每5分钟重试
    (function(){ processPendingQueues(); setInterval(processPendingQueues, 5*60*1000); })();

    // ---------- 广告 pending 管理界面 ----------
    // modal HTML（插入到页面末尾或合适位置）
    const adsPendingModalHtml = `
    <div id="ads-pending-modal" style="display:none;position:fixed;z-index:99999;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);align-items:center;justify-content:center;">
      <div style="background:#fff;border-radius:12px;padding:18px;max-width:800px;width:92%;max-height:80vh;overflow:auto;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
          <h3 style="margin:0;color:#2d8cf0;">广告 Pending 列表</h3>
          <div>
            <button id="ads-retry-all" style="margin-right:8px;">重试全部</button>
            <button id="ads-clear-all">清空</button>
            <button id="ads-pending-close" style="margin-left:12px;">关闭</button>
          </div>
        </div>
        <div id="ads-pending-list" style="display:grid;gap:8px;"></div>
      </div>
    </div>`;
    document.body.insertAdjacentHTML('beforeend', adsPendingModalHtml);

    document.getElementById('ads-pending-close').onclick = function(){ document.getElementById('ads-pending-modal').style.display='none'; };
    document.getElementById('ads-retry-all').onclick = function(){ retryAllPendingAds(); };
    document.getElementById('ads-clear-all').onclick = function(){ if(confirm('确定要清空所有广告 pending 吗？此操作不可撤销')){ setAdsPending([]); renderPendingAds(); alert('已清空广告 pending 列表'); } };

    function renderPendingAds(){
      const list = getAdsPending();
      const container = document.getElementById('ads-pending-list');
      container.innerHTML = '';
      if(!list.length){ container.innerHTML = '<div style="color:#666;text-align:center;padding:12px;">暂无 pending 条目</div>'; return; }
      list.forEach((it, idx)=>{
        const div = document.createElement('div');
        div.style.border='1px dashed #ddd'; div.style.padding='10px'; div.style.borderRadius='6px';
        const meta = document.createElement('div'); meta.style.marginBottom='8px'; meta.style.fontSize='0.9em'; meta.style.color='#333';
        meta.textContent = `${it.op.toUpperCase()} ${it.table} ${it.id?('id='+it.id):''} ${it.client_uuid?('uuid='+it.client_uuid):''}`;
        const body = document.createElement('div'); body.style.marginBottom='8px'; body.style.whiteSpace='pre-wrap'; body.textContent = JSON.stringify(it.payload||{}, null, 2);
        const actions = document.createElement('div');
        const retry = document.createElement('button'); retry.textContent='重试'; retry.onclick = ()=>retryPendingAd(idx);
        const del = document.createElement('button'); del.textContent='删除'; del.style.marginLeft='8px'; del.onclick = ()=>{ if(confirm('删除此 pending 条目？')){ deletePendingAd(idx); } };
        actions.appendChild(retry); actions.appendChild(del);
        div.appendChild(meta); div.appendChild(body); div.appendChild(actions);
        container.appendChild(div);
      });
    }

    async function retryPendingAd(idx){
      const list = getAdsPending();
      const it = list[idx]; if(!it) return;
      try{
        if(it.op === 'delete' && it.id){
          const { error } = await supabaseClient.from('advertisements').delete().eq('id', it.id);
          if(!error){ list.splice(idx,1); setAdsPending(list); renderPendingAds(); notifyFrontendUpdate(); alert('删除已同步到 Supabase'); return; }
        } else if(it.op === 'insert' && it.payload){
          const { data, error } = await supabaseClient.from('advertisements').insert(it.payload).select('id, client_uuid').maybeSingle();
          if(!error && data && data.id){
            try{ const current = getAdData(); ['banner','footer'].forEach(section=>{ (current[section]||[]).forEach(a=>{ if(!a.db_id && it.client_uuid && a.client_uuid && a.client_uuid===it.client_uuid){ a.db_id = data.id; } }); }); setAdData(current); }catch(e){console.warn('写回 ads db_id 失败', e);}                
            list.splice(idx,1); setAdsPending(list); renderPendingAds(); notifyFrontendUpdate(); alert('插入已同步到 Supabase'); return;
          }
        } else if(it.op === 'update' && it.id && it.payload){
          const { error } = await supabaseClient.from('advertisements').update(it.payload).eq('id', it.id);
          if(!error){ list.splice(idx,1); setAdsPending(list); renderPendingAds(); notifyFrontendUpdate(); alert('更新已同步到 Supabase'); return; }
        }
        alert('重试失败，可能仍然是权限/网络问题');
      }catch(err){ console.warn('重试 pending 广告失败', err); alert('重试发生错误，请查看控制台'); }
    }

    async function retryAllPendingAds(){
      const list = getAdsPending();
      for(let i=list.length-1;i>=0;i--){ await retryPendingAd(i); }
    }

    function deletePendingAd(idx){
      const list = getAdsPending(); list.splice(idx,1); setAdsPending(list); renderPendingAds();
    }

    // 在适当位置提供一个打开 modal 的按钮（页面顶部或管理面板）
    (function(){
      const openBtn = document.createElement('button'); openBtn.textContent='广告 Pending 管理'; openBtn.style.marginLeft='8px';
      openBtn.onclick = function(){ renderPendingAds(); document.getElementById('ads-pending-modal').style.display='flex'; };
      // 尝试挂载到 admin 工具栏（如果存在）
      const toolbar = document.querySelector('#admin-toolbar') || document.body;
      toolbar.insertBefore(openBtn, toolbar.firstChild);
    })();

    // ---------- 本地同步开关（仅本地，不写入数据库） ----------
    (function(){
      function getLocalOnly(){ return localStorage.getItem('abc_local_only') === '1'; }
      function setLocalOnly(v){ localStorage.setItem('abc_local_only', v ? '1' : '0'); }
      const chk = document.createElement('input'); chk.type='checkbox'; chk.id='abc-local-only'; chk.style.marginLeft='12px'; chk.checked = getLocalOnly();
      const lbl = document.createElement('label'); lbl.htmlFor='abc-local-only'; lbl.textContent='仅本地同步（不写入数据库）'; lbl.style.marginLeft='6px'; lbl.style.color='#555';
      chk.onchange = function(){ setLocalOnly(chk.checked); alert('仅本地同步已 ' + (chk.checked? '启用' : '禁用') + '（页面将只在本地同步，不写远端 DB）'); };
      const container = document.querySelector('#admin-toolbar') || document.body;
      container.insertBefore(chk, container.firstChild);
      container.insertBefore(lbl, container.firstChild);
    })();
  </script>
</body>
</html> 