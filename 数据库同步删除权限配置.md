# 数据库同步删除权限配置

## 问题描述
管理员在后台删除广告/通知后，需要同步删除数据库内容，确保前端会员页也看不到已删除的内容。

## 当前实现
- **通知**：每次"保存通知"会先删除数据库所有旧通知，再插入当前编辑的通知
- **广告**：每次"保存广告"会先删除数据库所有旧广告，再插入当前编辑的广告

## 需要的数据库权限

请在 Supabase SQL Editor 执行以下 SQL（无需反引号，直接粘贴执行）：

```sql
-- 为 notices 表添加 DELETE 权限和策略
ALTER TABLE public.notices ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "anon_delete" ON public.notices;
CREATE POLICY "anon_delete" ON public.notices 
  FOR DELETE TO anon 
  USING (true);
GRANT DELETE ON public.notices TO anon, authenticated;

-- 为 advertisements 表添加 DELETE 权限和策略
ALTER TABLE public.advertisements ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "anon_delete" ON public.advertisements;
CREATE POLICY "anon_delete" ON public.advertisements 
  FOR DELETE TO anon 
  USING (true);
GRANT DELETE ON public.advertisements TO anon, authenticated;

-- 刷新 REST 缓存
NOTIFY pgrst, 'reload schema';
```

## 工作流程

### 通知同步删除流程
1. 管理员在"通知管理"编辑通知（可以删除某条通知）
2. 点击"保存通知"
3. 后台先执行 `DELETE FROM notices WHERE id != 0`（删除所有旧通知）
4. 再插入当前编辑器中的所有通知
5. 前端会员页每30秒自动刷新，会立即看到最新通知列表

### 广告同步删除流程
1. 管理员在"广告管理"编辑广告（可以删除某条广告）
2. 点击"保存广告"
3. 后台先执行 `DELETE FROM advertisements WHERE id != 0`（删除所有旧广告）
4. 再插入当前编辑器中的所有广告
5. 前端会员页每30秒自动刷新，会立即看到最新广告列表

## 验证步骤

1. **执行上述 SQL**（配置DELETE权限）
2. 在后台"通知管理"删除一条通知，点"保存通知"
3. 在后台"广告管理"删除一条广告，点"保存广告"
4. 刷新前端会员页，确认删除的内容不再显示
5. 等待30秒，确认内容自动刷新同步

## 如果删除失败

如果保存时提示"删除旧广告/通知失败"，说明DELETE权限未配置。请执行上面的SQL语句，然后重试。

## 前端自动同步机制

- **通知**：每30秒自动从数据库读取最新通知
- **广告**：每30秒自动从数据库读取最新广告
- **实时性**：最多30秒延迟，确保前后端内容一致

---

**最后更新**：2025年1月
