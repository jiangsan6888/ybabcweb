# 广告表权限修复步骤

## 问题诊断

您遇到的大量 **400 错误** 是因为:
1. `advertisements` 表的 **Row Level Security (RLS)** 策略限制了 `anon` 角色的访问
2. `anon` 角色可能没有对特定列的 INSERT 权限
3. 可能存在 NOT NULL 约束冲突

## 解决方案

### 步骤 1: 打开 Supabase SQL Editor

1. 登录您的 Supabase 项目: https://supabase.com/dashboard
2. 选择您的项目
3. 点击左侧菜单的 **SQL Editor** (SQL 编辑器)
4. 点击 **New query** (新建查询)

### 步骤 2: 执行修复 SQL

**重要**: 请复制 `广告表权限修复.sql` 文件中的**整个 SQL 内容**，粘贴到 SQL Editor 中。

**不要包含** markdown 的代码块标记 (```sql 和 ```)，**只粘贴纯 SQL 语句**！

### 步骤 3: 运行查询

1. 粘贴 SQL 后，点击右下角的 **RUN** 按钮
2. 等待执行完成
3. 如果出现确认对话框，点击 **Run this query** 确认执行

### 步骤 4: 验证修复

执行完成后，您应该看到:
- ✅ `Success. No rows returned`（成功，无返回行）
- 或者显示创建/修改的对象数量

### 步骤 5: 测试功能

1. **刷新管理员页面** (`admin.html`)
2. 尝试添加一条广告（顶部或底部）
3. 填写文字或上传图片
4. 点击 **保存广告** 按钮
5. 观察:
   - ✅ 应该弹出成功提示: "有 X 条广告已发布到数据库..."
   - ✅ 浏览器控制台不应再有 400 错误
   - ✅ 在 Supabase Table Editor 中，`advertisements` 表应显示新数据

### 步骤 6: 验证会员端

1. 打开 `index.html` (会员端)
2. 刷新页面
3. 您应该能看到管理员发布的广告显示在页面顶部或底部

## 常见问题排查

### 如果仍然报错

**错误 1**: `permission denied for table advertisements`
```sql
-- 再次执行权限授予
GRANT ALL ON public.advertisements TO anon;
GRANT ALL ON public.advertisements TO authenticated;
```

**错误 2**: `column "ad_type" of relation "advertisements" does not exist`
```sql
-- 添加缺失的列
ALTER TABLE public.advertisements ADD COLUMN IF NOT EXISTS ad_type text;
ALTER TABLE public.advertisements ADD COLUMN IF NOT EXISTS type text;
```

**错误 3**: `null value in column "ad_type" violates not-null constraint`
```sql
-- 移除 NOT NULL 约束
ALTER TABLE public.advertisements ALTER COLUMN ad_type DROP NOT NULL;
```

### 检查表结构

在 SQL Editor 中运行:
```sql
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_schema = 'public' 
  AND table_name = 'advertisements'
ORDER BY ordinal_position;
```

应该看到这些列:
- `id` (bigint, NO)
- `ad_type` (text, YES)
- `type` (text, YES)
- `content` (text, YES)
- `imgs` (text, YES)
- `admin_id` (bigint, YES)
- `created_at` (timestamp with time zone, YES)

### 检查 RLS 策略

在 Supabase Dashboard:
1. 进入 **Table Editor**
2. 选择 `advertisements` 表
3. 点击右上角的 **齿轮图标** → **View policies**
4. 应该看到三个策略:
   - ✅ `Allow public insert on advertisements` (INSERT, anon, authenticated)
   - ✅ `Allow public select on advertisements` (SELECT, anon, authenticated)
   - ✅ `Allow public delete on advertisements` (DELETE, anon, authenticated)

## 完成！

修复后，您的广告系统应该能够:
- ✅ 管理员可以添加/保存广告到数据库
- ✅ 广告图片正确显示
- ✅ 会员端实时看到广告更新
- ✅ 删除的广告会同步消失
- ✅ 无 400 错误

