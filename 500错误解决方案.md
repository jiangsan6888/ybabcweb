# 500/502 错误解决方案

## 问题分析

您遇到的错误信息：
```
GET /rest/v1/notices?select=*&order=created_at.desc
500 (Internal Server Error)
502 (Bad Gateway)
```

### 错误原因

**主要原因**: `created_at` 列在数据库表中**不存在**或**数据类型不正确**

**次要原因**: 
- 表结构损坏
- 索引损坏
- REST API 缓存过期

## 解决方案

### 方案 1: 快速修复（推荐）

**第一步**: 打开 Supabase SQL Editor

**第二步**: 复制并执行 `快速修复500错误.sql` 中的所有 SQL

或者直接复制以下内容：

```sql
ALTER TABLE public.notices 
ADD COLUMN IF NOT EXISTS created_at timestamp with time zone 
DEFAULT timezone('utc'::text, now());

UPDATE public.notices 
SET created_at = timezone('utc'::text, now()) 
WHERE created_at IS NULL;

ALTER TABLE public.advertisements 
ADD COLUMN IF NOT EXISTS created_at timestamp with time zone 
DEFAULT timezone('utc'::text, now());

UPDATE public.advertisements 
SET created_at = timezone('utc'::text, now()) 
WHERE created_at IS NULL;

CREATE INDEX IF NOT EXISTS idx_notices_created_at 
ON public.notices(created_at DESC);

CREATE INDEX IF NOT EXISTS idx_advertisements_created_at 
ON public.advertisements(created_at DESC);

NOTIFY pgrst, 'reload schema';
NOTIFY pgrst, 'reload config';
```

**第三步**: 等待 5 秒，刷新网页测试

---

### 方案 2: 完整诊断（如果方案1无效）

**第一步**: 检查表结构

在 Supabase SQL Editor 执行：

```sql
SELECT column_name, data_type 
FROM information_schema.columns
WHERE table_schema = 'public' 
  AND table_name = 'notices';
```

**预期结果**应该包含：
- `id` (bigint)
- `content` (text)
- `img` (text)
- `time` (text)
- `admin_id` (bigint)
- `created_at` (timestamp with time zone) ← **重要！**

**如果缺少 `created_at`**，执行：
```sql
ALTER TABLE public.notices 
ADD COLUMN created_at timestamp with time zone 
DEFAULT timezone('utc'::text, now());

UPDATE public.notices 
SET created_at = timezone('utc'::text, now()) 
WHERE created_at IS NULL;
```

**第二步**: 对 `advertisements` 表执行同样检查

```sql
SELECT column_name, data_type 
FROM information_schema.columns
WHERE table_schema = 'public' 
  AND table_name = 'advertisements';
```

**第三步**: 刷新 REST API 缓存

```sql
NOTIFY pgrst, 'reload schema';
```

**第四步**: 在 Supabase Dashboard:
1. 点击左侧 **Settings** (设置)
2. 点击 **API**
3. 点击右上角的 **Reload config** 按钮（如果有）

---

### 方案 3: 重建表（最后手段）

**警告**: 这会删除现有数据！请先备份。

```sql
-- 备份数据
CREATE TABLE notices_backup AS SELECT * FROM public.notices;
CREATE TABLE advertisements_backup AS SELECT * FROM public.advertisements;

-- 删除旧表
DROP TABLE IF EXISTS public.notices CASCADE;
DROP TABLE IF EXISTS public.advertisements CASCADE;

-- 重新创建表（参考之前提供的 SQL）
CREATE TABLE public.notices (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  content text,
  img text,
  time text,
  admin_id bigint,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now())
);

CREATE TABLE public.advertisements (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  ad_type text,
  type text,
  content text,
  imgs text,
  admin_id bigint,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now())
);

-- 恢复数据（如果有）
INSERT INTO public.notices (content, img, time, admin_id, created_at)
SELECT content, img, time, admin_id, 
       COALESCE(created_at, timezone('utc'::text, now()))
FROM notices_backup;

-- 重新设置权限和 RLS（参考之前的 SQL）
ALTER TABLE public.notices ENABLE ROW LEVEL SECURITY;
-- ... 其他权限设置
```

---

## 验证修复

### 步骤 1: 在 SQL Editor 测试查询

```sql
-- 测试 notices（应该返回结果，不报错）
SELECT * FROM public.notices ORDER BY created_at DESC LIMIT 5;

-- 测试 advertisements（应该返回结果，不报错）
SELECT * FROM public.advertisements ORDER BY created_at DESC LIMIT 5;
```

### 步骤 2: 在浏览器测试

1. **清除浏览器缓存**（Ctrl + Shift + Delete）
2. **刷新网页**（Ctrl + F5 强制刷新）
3. **打开控制台**（F12）
4. **查看是否还有 500/502 错误**

### 步骤 3: 验证功能

- ✅ 通知能否正常显示？
- ✅ 广告能否正常显示？
- ✅ 管理员能否保存通知/广告？
- ✅ 控制台无 500/502 错误？

---

## 常见问题

### Q1: 执行 SQL 后仍然报 500 错误

**A**: 
1. 等待 10 秒（Supabase 需要时间刷新缓存）
2. 清除浏览器缓存并刷新
3. 在 Supabase Dashboard → Settings → API → 点击 "Reload config"

### Q2: CORS 错误怎么办？

**A**: CORS 错误通常伴随 500 错误出现。修复 500 错误后，CORS 错误会自动消失。

如果 CORS 错误持续，检查：
1. Supabase 项目的 URL 是否正确？
2. Anon Key 是否正确？
3. 在 Supabase Dashboard → Settings → API → CORS Settings 中是否允许您的域名

### Q3: 502 Bad Gateway 错误

**A**: 
- 502 通常表示 Supabase 服务暂时不可用
- 等待 1-2 分钟后重试
- 检查 https://status.supabase.com/ 查看服务状态

### Q4: "No 'Access-Control-Allow-Origin' header"

**A**: 这是 CORS 问题，通常由 500 错误引起。修复步骤：
1. 先修复 500 错误（使用上面的 SQL）
2. 刷新 REST API 缓存
3. 清除浏览器缓存
4. 重新测试

---

## 预防措施

为避免将来再次出现此问题：

### 1. 创建表时始终包含 created_at

```sql
CREATE TABLE your_table (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  -- 其他列...
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now())
);
```

### 2. 创建索引提高性能

```sql
CREATE INDEX idx_your_table_created_at 
ON your_table(created_at DESC);
```

### 3. 定期备份数据

在 Supabase Dashboard → Database → Backups 中启用自动备份

---

## 总结

**最可能的原因**: `created_at` 列缺失或类型错误

**快速解决方案**: 执行 `快速修复500错误.sql`

**验证步骤**: 
1. SQL 查询不报错
2. 网页无 500/502 错误
3. 功能正常使用

如果问题仍然存在，请提供：
1. 执行 SQL 后的结果截图
2. 浏览器控制台的完整错误信息
3. Supabase SQL Editor 中 `SELECT * FROM information_schema.columns WHERE table_name = 'notices'` 的查询结果

